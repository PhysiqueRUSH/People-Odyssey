<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People Odyssey</title>
  <link rel="icon" type="image/png" href="PeopleICO.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1d3a">

  <!-- Librairie OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #0b1d3a;
      color: white;
    }
    header { 
      padding: 1rem; 
      text-align: center; 
      background:#112b55; 
      font-size: 1.3rem;
      font-weight: bold;
    }
    .container { padding: 1rem; }
    .today-date {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 0.3rem;
      text-align: left;
    }
    .search-bar { display: flex; margin-bottom: .5rem; }
    .search-bar input { flex: 1; padding: .6rem; border:none; border-radius:6px; }
    .actions { display:flex; justify-content:space-between; margin-bottom:1rem; }
    .actions button, .bottom-actions button { 
      background:#1f3f7a; 
      border:none; 
      padding:.5rem 1rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
    }
    .patient-list { list-style:none; padding:0; margin-bottom: 3rem; }
    .patient-list li { 
      background:#16305a; 
      margin-bottom:.5rem; 
      padding:.6rem; 
      border-radius:6px; 
      display:flex; 
      align-items:center; 
      cursor:pointer;
    }
    #add-screen, #calendar-screen, #info-screen, #presence-screen, 
    #presence-date-screen, #day-screen, #facturation-screen, 
    #facturer-screen, #ocr-import-screen { 
      display:none; 
      padding:1rem; 
    }
    #add-screen input, #info-screen input, #info-screen textarea, 
    #presence-date-screen input, #facturation-screen input { 
      width:100%; 
      margin-bottom:.8rem; 
      padding:.6rem; 
      border:none; 
      border-radius:6px; 
    }
    .save-btn { 
      background:#28a745; 
      border:none; 
      padding:.6rem 1.2rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
      margin-right:.5rem; 
    }
    .back-btn { 
      background:#6c757d; 
      border:none; 
      padding:.6rem 1.2rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 8px;
    }
    .bottom-actions {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 1rem;
    }
    /* Menu patient */
    #patient-menu {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #patient-menu .menu-box {
      background: #112b55;
      border-radius: 8px;
      padding: 1rem;
      width: 80%;
      max-width: 400px;
    }
    #patient-menu button {
      display: block;
      width: 100%;
      margin: .4rem 0;
      background: #1f3f7a;
      border: none;
      padding: .6rem;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      text-align: left;
    }
    /* Calendrier */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      background: #16305a;
      border-radius: 4px;
      text-align: center;
      padding: .6rem;
      cursor: pointer;
      position: relative;
    }
    .calendar-day.red { background: red; }
    .calendar-day.orange { background: orange; }
    .calendar-day.green { background: green; }
    .calendar-day.blue { background: skyblue; }
    .calendar-day.selected { background: deepskyblue; color: white; font-weight: bold; }

    .pastille {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      position: absolute;
      bottom: 4px;
      right: 4px;
    }

    .phone-row {
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .phone-row input { flex: 1; }

    /* Boutons icÃ´ne tÃ©lÃ©phone / SMS */
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      padding: .6rem;
      border: none;
      border-radius: 6px;
      background: #1f3f7a;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .icon-btn:active { transform: scale(0.98); }

    /* OCR screen */
    .ocr-upload-row {
      display: flex;
      align-items: center;
      margin-bottom: .6rem;
    }
    .ocr-results {
      margin-top: 1rem;
      background:#16305a;
      padding: .6rem;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>People Odyssey</header>

  <!-- Ã‰cran principal -->
  <div id="main-screen" class="container">
    <div class="today-date" id="todayDate"></div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un patient...">
    </div>

    <div class="actions">
      <button onclick="showAddScreen()">+</button>
      <button onclick="showOcrScreen()">Captures Doctolib</button>
    </div>

    <ul class="patient-list" id="patientList"></ul>

    <div class="bottom-actions">
      <button onclick="showCalendar()">Calendrier</button>
      <button onclick="showFacturerScreen()">Ã€ facturer</button>
    </div>
  </div>

  <!-- Ã‰cran ajout patient -->
  <div id="add-screen" class="container">
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="prenom" placeholder="PrÃ©nom">
    <button class="save-btn" onclick="savePatient()">ðŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran calendrier global -->
  <div id="calendar-screen" class="container">
    <div class="calendar-header">
      <button onclick="prevMonth()">â—€</button>
      <span id="calendar-title"></span>
      <button onclick="nextMonth()">â–¶</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div>
      <div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>
    <!-- Ã‰cran informations patient -->
  <div id="info-screen" class="container">
    <h3 id="info-title"></h3>

    <div class="phone-row">
      <input type="tel" id="info-phone" placeholder="NumÃ©ro de tÃ©lÃ©phone">
      <button class="icon-btn" title="Appeler" onclick="callPatient()">ðŸ“ž</button>
      <button class="icon-btn" title="SMS" onclick="smsPatient()">ðŸ’¬</button>
    </div>

    <input type="text" id="info-rejet" placeholder="Rejet de paiement">
    <textarea id="info-notes" rows="4" placeholder="Autres notes..."></textarea>

    <button class="save-btn" onclick="saveInfo()">ðŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>
    <!-- Ã‰cran sÃ©lection prÃ©sences -->
  <div id="presence-screen" class="container">
    <h3>SÃ©lectionner les prÃ©sences</h3>
    <div class="calendar-header">
      <button onclick="prevPresenceMonth()">â—€</button>
      <span id="presence-title"></span>
      <button onclick="nextPresenceMonth()">â–¶</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div>
      <div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="presence-grid"></div>
    <button class="save-btn" onclick="savePresenceSelection()">ðŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran ajout prÃ©sence par date -->
  <div id="presence-date-screen" class="container">
    <h3>PrÃ©sent le ...</h3>
    <input type="text" id="presence-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="savePresenceByDate()">ðŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran patients d'une journÃ©e -->
  <div id="day-screen" class="container">
    <h3 id="day-title"></h3>
    <ul id="day-patient-list"></ul>
    <button class="back-btn" onclick="showCalendar()">â†© Retour</button>
  </div>
    <!-- Ã‰cran derniÃ¨re facturation -->
  <div id="facturation-screen" class="container">
    <h3>Date de la derniÃ¨re facturation</h3>
    <input type="text" id="facturation-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="saveFacturationDate()">ðŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran : Ã€ facturer -->
  <div id="facturer-screen" class="container">
    <h3>Patients Ã  facturer</h3>
    <ul class="facturer-list" id="facturer-list"></ul>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran import OCR (captures Doctolib) -->
  <div id="ocr-import-screen" class="container ocr-screen">
    <h3>Importer captures Doctolib</h3>

    <div class="ocr-upload-row">
      <label style="min-width:90px">Capture 1</label>
      <input type="file" id="ocr-file-1" accept="image/*" />
    </div>

    <div class="ocr-upload-row">
      <label style="min-width:90px">Capture 2 (optionnelle)</label>
      <input type="file" id="ocr-file-2" accept="image/*" />
    </div>

    <div>
      <label>Choisir la date :</label>
      <input type="text" id="ocr-presence-date" placeholder="jj/mm/aaaa (vide = aujourd'hui)" />
    </div>

    <div class="ocr-actions">
      <button class="save-btn" id="ocr-process-btn">ðŸ”Ž Extraire</button>
      <button class="back-btn" onclick="hideOcrScreen()">â†© Retour</button>
    </div>

    <div class="ocr-results" id="ocr-results" aria-live="polite"></div>

    <div style="margin-top:.6rem;">
      <button class="save-btn" id="ocr-import-confirm" style="display:none;">âœ… Importer</button>
      <button class="back-btn" id="ocr-import-cancel" style="display:none;" onclick="hideOcrScreen()">âœ– Annuler</button>
    </div>
  </div>
    <!-- Menu patient -->
  <div id="patient-menu">
    <div class="menu-box">
      <button onclick="showInfoScreen()">Informations</button>
      <button onclick="addPresenceOffset(0)">PrÃ©sent ce jour</button>
      <button onclick="addPresenceOffset(1)">PrÃ©sent demain</button>
      <button onclick="addPresenceOffset(2)">PrÃ©sent aprÃ¨s-demain</button>
      <button onclick="showPresenceSelection()">SÃ©lectionner les prÃ©sences</button>
      <button onclick="showPresenceByDate()">PrÃ©sent le ...</button>
      <button onclick="showFacturationScreen()">Date de la derniÃ¨re facturation</button>
    </div>
  </div>

  <script>
    const patientListEl = document.getElementById("patientList");
    const searchInput = document.getElementById("searchInput");
    const patientMenu = document.getElementById("patient-menu");
    const todayDateEl = document.getElementById("todayDate");
    const dayPatientList = document.getElementById("day-patient-list");
    const facturerList = document.getElementById("facturer-list");

    let currentYear, currentMonth;
    let presenceYear, presenceMonth;
    let selectedPatientIndex = null;
    let presenceSelection = new Set();
    let currentDayView = null;

    function formatDate(date) {
      return date.toLocaleDateString("fr-FR");
    }

    // Normaliser une date jj/mm/aa â†’ jj/mm/aaaa
    function normalizeDate(input) {
      const parts = input.split("/");
      if (parts.length === 3) {
        let [jj, mm, aa] = parts;
        if (aa.length === 2) aa = "20" + aa;
        return `${jj.padStart(2,"0")}/${mm.padStart(2,"0")}/${aa}`;
      }
      return input;
    }

    // Date du jour
    function showToday() {
      const today = new Date();
      const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
      todayDateEl.textContent = today.toLocaleDateString("fr-FR", options);
    }

    // Navigation : cacher tous les Ã©crans
    function hideAll() {
      [
        "main-screen","add-screen","calendar-screen","info-screen",
        "presence-screen","presence-date-screen","day-screen",
        "facturation-screen","facturer-screen","ocr-import-screen"
      ].forEach(id => {
        document.getElementById(id).style.display="none";
      });
    }

    // Navigation : afficher Ã©crans
    function showAddScreen() { hideAll(); document.getElementById("add-screen").style.display="block"; }
    function showMainScreen() { hideAll(); document.getElementById("main-screen").style.display="block"; renderPatients(searchInput.value); }
    function showCalendar() { hideAll(); document.getElementById("calendar-screen").style.display="block"; renderCalendar(); }
    function showInfoScreen() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("info-screen").style.display = "block";
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      document.getElementById("info-title").textContent = p.nom + " " + p.prenom;
      document.getElementById("info-phone").value = p.phone || "";
      document.getElementById("info-rejet").value = p.rejet || "";
      document.getElementById("info-notes").value = p.notes || "";
    }
    function showPresenceSelection() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("presence-screen").style.display = "block";
      const today = new Date();
      presenceYear = today.getFullYear();
      presenceMonth = today.getMonth();
      presenceSelection = new Set(
        (JSON.parse(localStorage.getItem("patients"))[selectedPatientIndex].presences || [])
      );
      renderPresenceCalendar();
    }
    function showPresenceByDate() { patientMenu.style.display="none"; hideAll(); document.getElementById("presence-date-screen").style.display="block"; }
    function showDayScreen(dateStr) { hideAll(); document.getElementById("day-screen").style.display="block"; updateDayTitle(dateStr); currentDayView=dateStr; renderDayPatients(dateStr); }
    function showFacturationScreen() { patientMenu.style.display="none"; hideAll(); document.getElementById("facturation-screen").style.display="block"; }
    function showFacturerScreen() { hideAll(); document.getElementById("facturer-screen").style.display="block"; renderFacturerList(); }
    function showOcrScreen() { hideAll(); document.getElementById("ocr-import-screen").style.display="block"; document.getElementById("ocr-results").innerHTML=""; document.getElementById("ocr-import-confirm").style.display="none"; document.getElementById("ocr-import-cancel").style.display="none"; }

    // Menu patient
    function showPatientMenu(index) { selectedPatientIndex=index; patientMenu.style.display="flex"; }
    patientMenu.addEventListener("click", e => { if (e.target===patientMenu) patientMenu.style.display="none"; });
        // --- Patients ---
    function renderPatients(filter = "") {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patientListEl.innerHTML = "";

      patients
        .filter(p => (p.nom + " " + p.prenom).toLowerCase().includes(filter.toLowerCase()))
        .forEach((p, index) => {
          const li = document.createElement("li");

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "ðŸ—‘ï¸";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePatient(index);
          };

          const span = document.createElement("span");
          span.textContent = p.nom + " " + p.prenom;
          if (p.rejet && p.rejet.trim() !== "") span.textContent += " âš ï¸";

          li.appendChild(deleteBtn);
          li.appendChild(span);
          li.onclick = () => showPatientMenu(index);

          patientListEl.appendChild(li);
        });
    }

    function savePatient() {
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      if (!nom || !prenom) { alert("Veuillez remplir Nom et PrÃ©nom"); return; }
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.push({ nom, prenom, phone:"", rejet:"", notes:"", presences:[], facturationDate:"" });
      localStorage.setItem("patients", JSON.stringify(patients));
      document.getElementById("nom").value = "";
      document.getElementById("prenom").value = "";
      showMainScreen();
      renderPatients(searchInput.value);
    }

    function deletePatient(index) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.splice(index, 1);
      localStorage.setItem("patients", JSON.stringify(patients));
      renderPatients(searchInput.value);
    }

    // --- Sauvegarde infos patient ---
    function saveInfo() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      if (selectedPatientIndex === null) return;
      patients[selectedPatientIndex].phone = document.getElementById("info-phone").value.trim();
      patients[selectedPatientIndex].rejet = document.getElementById("info-rejet").value.trim();
      patients[selectedPatientIndex].notes = document.getElementById("info-notes").value.trim();
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    // --- PrÃ©sences ---
    function addPresenceOffset(offset) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      const d = new Date();
      d.setDate(d.getDate()+offset);
      const dateStr = formatDate(d);
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      patientMenu.style.display="none";
    }

    function savePresenceByDate() {
      let dateStr = document.getElementById("presence-date").value.trim();
      if (!dateStr) return;
      dateStr = normalizeDate(dateStr);
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    function prevPresenceMonth(){presenceMonth--; if(presenceMonth<0){presenceMonth=11;presenceYear--;} renderPresenceCalendar();}
    function nextPresenceMonth(){presenceMonth++; if(presenceMonth>11){presenceMonth=0;presenceYear++;} renderPresenceCalendar();}
    function savePresenceSelection() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].presences = Array.from(presenceSelection);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }
        // --- Facturation ---
    function saveFacturationDate() {
      let dateStr = document.getElementById("facturation-date").value.trim();
      if (dateStr) dateStr = normalizeDate(dateStr);
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].facturationDate = dateStr || "";
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    function isFactured(p, dateStr) {
      if (!p.facturationDate) return false;
      const [dd, mm, yyyy] = p.facturationDate.split("/");
      const factDate = new Date(`${yyyy}-${mm}-${dd}`);
      const [dd2, mm2, yyyy2] = dateStr.split("/");
      const checkDate = new Date(`${yyyy2}-${mm2}-${dd2}`);
      return checkDate <= factDate;
    }

    function countFacturedVsNonFactured(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let total = 0, nonFactured = 0;
      patients.forEach(p => {
        if (p.presences && p.presences.includes(dateStr)) {
          total++;
          if (!isFactured(p, dateStr)) nonFactured++;
        }
      });
      return { total, nonFactured };
    }

    // --- Liste "Ã€ facturer" ---
    function renderFacturerList() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");

      let data = patients.map(p => {
        const nonFact = (p.presences || []).filter(date => !isFactured(p, date)).length;
        return { ...p, nonFact };
      }).filter(p => p.nonFact > 0);

      data.sort((a, b) => {
        if (b.nonFact !== a.nonFact) return b.nonFact - a.nonFact;
        return (a.nom + " " + a.prenom).localeCompare(b.nom + " " + b.prenom);
      });

      facturerList.innerHTML = "";
      data.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.nom} ${p.prenom} (${p.nonFact})`;

        if (p.nonFact > 20) li.style.color="red";
        else if (p.nonFact > 10) li.style.color="orange";
        else if (p.nonFact >= 5) li.style.color="yellow";
        else if (p.nonFact >= 2) li.style.color="green";
        else li.style.color="blue";

        facturerList.appendChild(li);
      });
    }
        // --- OCR Import (Doctolib avec Tesseract.js) ---
    function hideOcrScreen() {
      document.getElementById("ocr-import-screen").style.display="none";
    }

    function fuzzyMatch(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      let longer = a.length > b.length ? a : b;
      let shorter = a.length > b.length ? b : a;
      const longerLength = longer.length;
      if (longerLength === 0) return 1.0;
      const editDistance = (s1, s2) => {
        const costs = [];
        for (let i=0;i<=s1.length;i++) {
          let lastValue = i;
          for (let j=0;j<=s2.length;j++) {
            if (i===0) costs[j]=j;
            else {
              if (j>0) {
                let newValue = costs[j-1];
                if (s1.charAt(i-1)!==s2.charAt(j-1)) {
                  newValue = Math.min(Math.min(newValue,lastValue),costs[j])+1;
                }
                costs[j-1]=lastValue;
                lastValue=newValue;
              }
            }
          }
          if (i>0) costs[s2.length]=lastValue;
        }
        return costs[s2.length];
      };
      return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    async function extractTextFromFile(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve("");
        Tesseract.recognize(file, 'fra', { logger: m => console.log(m) })
          .then(({ data: { text } }) => resolve(text))
          .catch(err => reject(err));
      });
    }

    document.getElementById("ocr-process-btn").addEventListener("click", async () => {
      const file1 = document.getElementById("ocr-file-1").files[0];
      const file2 = document.getElementById("ocr-file-2").files[0];
      if (!file1 && !file2) { alert("Ajoutez au moins une capture."); return; }

      const dateInput = document.getElementById("ocr-presence-date").value.trim();
      const today = new Date();
      const dateStr = dateInput ? normalizeDate(dateInput) : formatDate(today);

      let text1 = await extractTextFromFile(file1);
      let text2 = await extractTextFromFile(file2);
      let combined = (text1 + "\n" + text2).trim();

      // DÃ©coupe par lignes
      let lines = combined.split("\n").map(l => l.trim()).filter(l => l.length > 0);

      const resultsDiv = document.getElementById("ocr-results");
      resultsDiv.innerHTML = "<h4>Patients dÃ©tectÃ©s</h4>";

      const patients = JSON.parse(localStorage.getItem("patients") || "[]");

      lines.forEach(name => {
        const div = document.createElement("div");
        const checkbox = document.createElement("input");
        checkbox.type="checkbox";
        checkbox.checked=true;

        let matchIndex = -1, bestScore=0;
        patients.forEach((p,idx)=>{
          const score=fuzzyMatch(name, p.nom+" "+p.prenom);
          if (score>bestScore) { bestScore=score; matchIndex=idx; }
        });

        checkbox.dataset.name=name;
        if (matchIndex!==-1 && bestScore>0.7) checkbox.dataset.index=matchIndex;

        div.appendChild(checkbox);
        div.appendChild(document.createTextNode(" "+name+(matchIndex!==-1 ? " (corrÃ©lÃ©)" : " (nouveau)")));
        resultsDiv.appendChild(div);
      });

      document.getElementById("ocr-import-confirm").style.display="inline-block";
      document.getElementById("ocr-import-cancel").style.display="inline-block";

      document.getElementById("ocr-import-confirm").onclick = () => {
        const checked = [...resultsDiv.querySelectorAll("input[type=checkbox]:checked")];
        const patients = JSON.parse(localStorage.getItem("patients") || "[]");
        checked.forEach(cb => {
          if (cb.dataset.index) {
            let p=patients[cb.dataset.index];
            if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
          } else {
            const parts = cb.dataset.name.split(" ");
            const nom = parts.shift();
            const prenom = parts.join(" ");
            patients.push({ nom, prenom, phone:"", rejet:"", notes:"", presences:[dateStr], facturationDate:"" });
          }
        });
        localStorage.setItem("patients", JSON.stringify(patients));
        hideOcrScreen();
        showMainScreen();
      };
    });
        // --- TÃ©lÃ©phone & SMS ---
    function normalizePhone(num) { return (num||"").replace(/\s+/g,""); }
    function callPatient() {
      const num=document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun numÃ©ro renseignÃ©."); return; }
      window.location.href="tel:"+normalizePhone(num);
    }
    function smsPatient() {
      const num=document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun numÃ©ro renseignÃ©."); return; }
      window.location.href="sms:"+normalizePhone(num);
    }

    // --- Calendrier global ---
    function countPresences(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let count=0; patients.forEach(p=>{ if(p.presences && p.presences.includes(dateStr)) count++; });
      return count;
    }

    function renderCalendar() {
      const titleEl=document.getElementById("calendar-title");
      const gridEl=document.getElementById("calendar-grid");
      const today=new Date();
      if (currentYear===undefined) { currentYear=today.getFullYear(); currentMonth=today.getMonth(); }
      const firstDay=new Date(currentYear,currentMonth,1);
      const lastDay=new Date(currentYear,currentMonth+1,0);
      const monthName=firstDay.toLocaleString("fr-FR",{month:"long"});
      titleEl.textContent=monthName+" "+currentYear;
      gridEl.innerHTML="";
      const startDay=firstDay.getDay()===0?6:firstDay.getDay()-1;
      for(let i=0;i<startDay;i++) gridEl.appendChild(document.createElement("div"));
      for(let d=1;d<=lastDay.getDate();d++){
        const date=new Date(currentYear,currentMonth,d);
        const dateStr=formatDate(date);
        const { total, nonFactured }=countFacturedVsNonFactured(dateStr);
        const dayEl=document.createElement("div");
        dayEl.className="calendar-day";
        dayEl.textContent=d;

        if (total>40) dayEl.classList.add("red");
        else if (total>=35) dayEl.classList.add("orange");
        else if (total>=5) dayEl.classList.add("green");
        else if (total>=1) dayEl.classList.add("blue");

        if (total>0) {
          const pastille=document.createElement("span");
          pastille.className="pastille";
          if (nonFactured/total>0.5) pastille.style.background="red";
          else if (nonFactured>0) pastille.style.background="orange";
          else pastille.style.background="darkgreen";
          dayEl.appendChild(pastille);
        }

        dayEl.onclick=()=>showDayScreen(dateStr);
        gridEl.appendChild(dayEl);
      }
    }

    function prevMonth(){currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar();}
    function nextMonth(){currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar();}

    // --- Init ---
    searchInput.addEventListener("input",()=>renderPatients(searchInput.value));
    showToday();
    renderPatients();
  </script>
</body>
</html>
