<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People Odyssey</title>
  <link rel="icon" type="image/png" href="PeopleICO.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1d3a">

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #0b1d3a;
      color: white;
    }
    header {
  padding: 0;            /* plus de padding pour que l'image touche les bords */
  text-align: center;
  background: #112b55;
}
    .container { padding: 1rem; }
    .today-date {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 0.3rem;
      text-align: left;
    }
    .search-bar { display: flex; margin-bottom: .5rem; }
    .search-bar input { flex: 1; padding: .6rem; border:none; border-radius:6px; }
    .actions { display:flex; justify-content:space-between; margin-bottom:1rem; }

.count-chip{
  background:#112b55;
  border:1px solid #274b8a;
  padding:.4rem .8rem;
  border-radius:999px;
  font-weight:bold;
  min-width:3rem;
  text-align:center;
  align-self:center;
}
.actions { gap: .6rem; } /* un petit espace entre les 3 Ã©lÃ©ments */

    #row-top, #row-second { align-items: center; }
#row-second .count-chip { text-align: center; margin: 0 .2rem; }

    
    .actions button, .bottom-actions button { 
      background:#1f3f7a; 
      border:none; 
      padding:.5rem 1rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
    }

.app-title-img {
  display: block;
  width: 100%;   /* prend toute la largeur disponible */
  height: auto;  /* conserve les proportions de l'image */
  user-select: none;
  -webkit-user-drag: none;
}

    
    .patient-list { list-style:none; padding:0; margin-bottom: 3rem; }
    .patient-list li { 
      background:#16305a; 
      margin-bottom:.5rem; 
      padding:.6rem; 
      border-radius:6px; 
      display:flex; 
      align-items:center; 
      cursor:pointer;
    }
    #add-screen, #calendar-screen, #info-screen, #presence-screen, 
#presence-date-screen, #day-screen, #facture-screen, #ocr-import-screen,
#facturation-date-screen, #special-screen, #patient-sessions-screen { 
  display:none; padding:1rem; 
}
    #add-screen input:not([type="checkbox"]),
#info-screen input:not([type="checkbox"]),
#presence-date-screen input:not([type="checkbox"]),
#facturation-date-screen input:not([type="checkbox"]),
#info-screen textarea {
  width:100%;
  margin-bottom:.8rem;
  padding:.6rem;
  border:none;
  border-radius:6px;
}

    .save-btn { background:#28a745; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; margin-right:.5rem; }
    .back-btn { background:#6c757d; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 8px;
    }
    .bottom-actions {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 1rem;
    }


.facture-estimate{
  font-size: 0.95rem;   /* lÃ©gÃ¨rement moins gros que le titre */
  font-style: italic;
  color: #ddd;
  margin-top: .2rem;
  margin-bottom: .6rem;
}

    
/* style facultatif si le patient existe dÃ©jÃ  */
.ocr-name.exists{
  opacity:.7;
  font-style:italic;
}


    
    /* Menu patient */
    #patient-menu {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #patient-menu .menu-box {
      background: #112b55;
      border-radius: 8px;
      padding: 1rem;
      width: 80%;
      max-width: 400px;
    }
    #patient-menu button {
      display: block;
      width: 100%;
      margin: .4rem 0;
      background: #1f3f7a;
      border: none;
      padding: .6rem;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      text-align: left;
    }
    /* Calendrier */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      background: #16305a;
      border-radius: 4px;
      text-align: center;
      padding: .6rem;
      cursor: pointer;
      position: relative;
    }
    .calendar-day.selected { background: deepskyblue; color: white; font-weight: bold; }
    .pastille {
      width:10px;
      height:10px;
      border-radius:50%;
      position:absolute;
      bottom:4px;
      right:4px;
    }
    /* IntensitÃ© de frÃ©quentation (calendrier global) */
.calendar-day.red    { background:#8b1e1e; color:#fff; }
.calendar-day.orange { background:#b15b00; color:#fff; }
.calendar-day.green  { background:#106b2b; color:#fff; }
.calendar-day.blue   { background:#1f3f7a; color:#fff; }
    
    .phone-row {
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .phone-row input { flex: 1; }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      padding: .6rem;
      border: none;
      border-radius: 6px;
      background: #1f3f7a;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .icon-btn:active { transform: scale(0.98); }

    .pin-btn {
  background:#1f3f7a;
  border:2px solid #1f3f7a;
  padding:.35rem .7rem;
  border-radius:999px;
  font-size:1.1rem;
  cursor:pointer;
}

.pin-red    { background:#8b1e1e; border-color:#8b1e1e; color:#fff; }
.pin-orange { background:#b15b00; border-color:#b15b00; color:#fff; }
.pin-yellow { background:#7a6b00; border-color:#7a6b00; color:#fff; }
.pin-green  { background:#218c3a; border-color:#218c3a; color:#fff; } /* vert clair */
.pin-blue   { background:#005eff; border-color:#005eff; color:#fff; } /* bleu Ã©lectrique */

@keyframes glow {
  0%   { box-shadow: 0 0 0px 0 rgba(255,255,255,.6); }
  50%  { box-shadow: 0 0 12px 3px rgba(255,255,255,.85); }
  100% { box-shadow: 0 0 0px 0 rgba(255,255,255,.6); }
}.pin-blink { animation: glow 1.2s infinite; }

/* OCR Ajout â€” identique Ã  PrÃ©vus */
#add-ocr-results ul{
  list-style: disc;
  margin: .5rem 0 0 1.2rem;
  padding: 0;
}
#add-ocr-results li{
  display: list-item;
  margin: .35rem 0;
  padding: 0;
  line-height: 1.4;
}
#add-ocr-results input[type="checkbox"]{
  vertical-align: middle;
  margin-right: .45rem;
  position: static;   /* pas de float ni dâ€™auto-align Ã  droite */
}

#add-ocr-results label {
  vertical-align: middle;
}

#add-ocr-results li { 
  cursor: pointer; 
  user-select: none; 
}

#add-ocr-results input[type="checkbox"] { 
  width: auto;  /* sÃ©curitÃ© si une rÃ¨gle globale force une largeur */
}


 /* --- Badges & actions en ligne --- */
li .emoji { margin-left:.35rem; cursor:default; user-select:none; }
li .emoji.clickable { cursor:pointer; }
li .right-edge { margin-left:auto; display:inline-flex; align-items:center; gap:.25rem; }

/* Listes autres que .patient-list (jour) -> forcer flex comme la liste principale */
#day-patient-list li{
  background:#16305a; 
  margin-bottom:.5rem; 
  padding:.6rem; 
  border-radius:6px; 
  display:flex; 
  align-items:center; 
}

/* Info-bulle Ã©phÃ©mÃ¨re pour â“ */
.tooltip-bubble{
  position:absolute;
  right:.6rem;
  top:50%;
  transform:translateY(-50%);
  background:rgba(0,0,0,.9);
  color:#fff;
  padding:.35rem .55rem;
  border-radius:6px;
  font-size:.9rem;
  pointer-events:none;
  z-index:10;
  max-width:70%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Pour placer les bulles par rapport aux LI */
.patient-list li, #specialList li, #day-patient-list li { position:relative; }

 /* Bouton âŒ de la barre de recherche */
.search-bar .clear-btn{
  background:#1f3f7a;
  border:none;
  padding:.4rem .6rem;
  border-radius:6px;
  color:#fff;
  cursor:pointer;
  margin-right:.4rem;
  min-width:44px;
}

#facture-list li{
  background:#16305a; 
  margin-bottom:.5rem; 
  padding:.6rem; 
  border-radius:6px; 
  display:flex; 
  align-items:center; 
}
 
   
   
</style>
  
</head>
<body>
  <header>
  <img src="./Titre.png" alt="People Odyssey" class="app-title-img">
</header>


  <!-- Ã‰cran principal -->
  <div id="main-screen" class="container">
    <div class="today-date" id="todayDate"></div>
    <div class="search-bar">
  <button id="clearSearchBtn" class="clear-btn" title="Effacer la recherche" onclick="clearMainSearch()">âŒ</button>
  <input type="text" id="searchInput" placeholder="Rechercher un patient...">
  <button id="sortToggleBtn" title="Changer l'ordre" style="margin-left:.4rem;" onclick="cycleSortMode()">â†•ï¸</button>
</div>



<!-- RangÃ©e 1 : +  |  ğŸ“Œ  |  ğŸ“¸PrÃ©vusğŸ§¾ -->
<div class="actions" id="row-top">
  <button onclick="showAddScreen()">â•ğŸ™‹â€â™‚ï¸/ğŸ™‹â€â™€ï¸</button>
  <button id="pinButton" class="pin-btn" title="Liste spÃ©ciale" onclick="showSpecialList()">ğŸ“Œ</button>
  <button onclick="showOcrScreen()">ğŸ“¸PrÃ©vusğŸ§¾</button>
</div>

<!-- RangÃ©e 2 : Calendrier |  [XX patients]  | Ã€ facturer -->
<div class="actions" id="row-second">
  <button onclick="showCalendar()">Calendrier</button>
  <span id="patientCount" class="count-chip">0 patients</span>
  <button onclick="showFactureScreen()">Ã€ facturer</button>
</div>

    <ul class="patient-list" id="patientList"></ul>
  </div>

  <!-- Ã‰cran ajout patient -->
<div id="add-screen" class="container">
  <input type="text" id="nom" placeholder="Nom">
  <input type="text" id="prenom" placeholder="PrÃ©nom">

  <!-- NOUVEAU : OCR Doctolib intÃ©grÃ© Ã  l'ajout -->
  <h4>Importer des patients depuis Doctolib (optionnel)</h4>
  <input type="file" id="add-ocr-file-1" accept="image/*"><br>
  <input type="file" id="add-ocr-file-2" accept="image/*"><br>
  <input type="file" id="add-ocr-file-3" accept="image/*"><br>
  <input type="file" id="add-ocr-file-4" accept="image/*"><br>
  <input type="file" id="add-ocr-file-5" accept="image/*"><br>
  <button class="save-btn" id="add-ocr-process-btn">ğŸ” Extraire</button>
  <div id="add-ocr-results" style="margin:.6rem 0;"></div>
  <button class="save-btn" id="add-ocr-import-btn" style="display:none;">âœ… Ajouter sÃ©lection</button>

  <hr style="opacity:.2;margin:1rem 0;">

  <!-- Ajout manuel classique -->
  <button class="save-btn" onclick="savePatient()">ğŸ’¾ Enregistrer</button>
  <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
</div>


  <!-- Ã‰cran calendrier global -->
  <div id="calendar-screen" class="container">
    <div class="calendar-header">
      <button onclick="prevMonth()">â—€</button>
      <span id="calendar-title"></span>
      <button onclick="nextMonth()">â–¶</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran "Ã€ facturer" -->
  <div id="facture-screen" class="container">
    <h3 id="facture-title">Patients avec sÃ©ances non facturÃ©es</h3>
    <div id="facture-estimate" class="facture-estimate"></div>
    <ul id="facture-list"></ul>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran liste des sÃ©ances du patient -->
<div id="patient-sessions-screen" class="container" style="display:none;">
  <h3 id="patient-sessions-title"></h3>
  <ul id="patient-sessions-list"></ul>
  <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
</div>


  <!-- Ã‰cran Liste spÃ©ciale -->
<div id="special-screen" class="container">
  <h3 id="special-title">Liste spÃ©ciale</h3>
  <ul class="patient-list" id="specialList"></ul>
  <div class="bottom-actions">
    <button onclick="showCalendar()">Calendrier</button>
    <button onclick="showMainScreen()">â†© Retour</button>
  </div>
</div>


  <!-- Ã‰cran OCR import -->
  <div id="ocr-import-screen" class="container">
    <h3>Importer la liste des patients du jour</h3>
    <input type="file" id="ocr-file-1" accept="image/*"><br>
    <input type="file" id="ocr-file-2" accept="image/*"><br>
    <input type="file" id="ocr-file-3" accept="image/*"><br>
    <input type="file" id="ocr-file-4" accept="image/*"><br>
    <input type="file" id="ocr-file-5" accept="image/*"><br>
    <input type="text" id="ocr-presence-date" placeholder="jj/mm/aaaa (vide = aujourd'hui)">
    <button class="save-btn" id="ocr-process-btn">ğŸ” Extraire</button>
    <button class="back-btn" onclick="hideOcrScreen()">â†© Retour</button>
    <div id="ocr-results"></div>
    <button class="save-btn" id="ocr-import-confirm" style="display:none;">âœ… Importer</button>
    <button class="back-btn" onclick="hideOcrScreen()">âœ– Annuler</button>
  </div>
  
  <!-- Ã‰cran informations patient -->
<div id="info-screen" class="container">
  <h3 id="info-title"></h3>
  <!-- NOUVEAU : Ã©dition du nom/prÃ©nom -->
  <div class="phone-row" style="gap:.6rem;">
    <input type="text" id="info-nom" placeholder="Nom (MAJUSCULES)">
    <input type="text" id="info-prenom" placeholder="PrÃ©nom">
  </div>

  <div class="phone-row">
    <input type="tel" id="info-phone" placeholder="NumÃ©ro de tÃ©lÃ©phone">
    <button class="icon-btn" title="Appeler" onclick="callPatient()">ğŸ“</button>
    <button class="icon-btn" title="SMS" onclick="smsPatient()">ğŸ’¬</button>
  </div>
  <input type="text" id="info-rejet" placeholder="Rejet de paiement">
  <textarea id="info-notes" rows="4" placeholder="Autres notes..."></textarea>
  <!-- Ordonnances -->
<div class="phone-row" style="gap:.8rem; align-items:center;">
  <label style="display:flex;align-items:center;gap:.35rem;">
    <input type="checkbox" id="info-ord-nonscan">
    <span>Ordonnance non scannÃ©e</span>
  </label>
  <label style="display:flex;align-items:center;gap:.35rem;">
    <input type="checkbox" id="info-ord-renouv">
    <span>Ordonnance Ã  renouveler</span>
  </label>
</div>
<input type="text" id="info-ord-details" placeholder="ordonnance du jj/mm/aaaa â€” localisation"
       style="width:100%;margin:.6rem 0 .2rem 0;padding:.6rem;border:none;border-radius:6px;display:none;">

  <button class="save-btn" onclick="saveInfo()">ğŸ’¾ Enregistrer</button>
  <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
</div>


  <!-- Ã‰cran sÃ©lection prÃ©sences -->
  <div id="presence-screen" class="container">
    <h3>SÃ©lectionner les prÃ©sences</h3>
    <div class="calendar-header">
      <button onclick="prevPresenceMonth()">â—€</button>
      <span id="presence-title"></span>
      <button onclick="nextPresenceMonth()">â–¶</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="presence-grid"></div>
    <hr style="opacity:.2;margin:.8rem 0;">
<h4>Importer des dates depuis Doctolib (optionnel)</h4>
<input type="file" id="pres-ocr-file-1" accept="image/*"><br>
<input type="file" id="pres-ocr-file-2" accept="image/*"><br>
<input type="file" id="pres-ocr-file-3" accept="image/*"><br>
<input type="file" id="pres-ocr-file-4" accept="image/*"><br>
<input type="file" id="pres-ocr-file-5" accept="image/*"><br>
<button class="save-btn" id="pres-ocr-process-btn">ğŸ” Extraire dates</button>
<div id="pres-ocr-results" style="margin:.6rem 0;"></div>
<button class="save-btn" id="pres-ocr-import-btn" style="display:none;">âœ… Ajouter sÃ©lection</button>

    <button class="save-btn" onclick="savePresenceSelection()">ğŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran ajout prÃ©sence par date -->
  <div id="presence-date-screen" class="container">
    <h3>PrÃ©sent le ...</h3>
    <input type="text" id="presence-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="savePresenceByDate()">ğŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

  <!-- Ã‰cran patients d'une journÃ©e -->
  <div id="day-screen" class="container">
    <h3 id="day-title"></h3>
    <div class="search-bar" style="margin-top:.4rem;">
  <input type="text" id="daySearchInput" placeholder="Rechercher parmi les prÃ©sents...">
  <button id="daySortToggleBtn" title="Changer l'ordre" style="margin-left:.4rem;" onclick="cycleDaySortMode()">â†•ï¸</button>
</div>
    <ul id="day-patient-list"></ul>
    <button class="back-btn" onclick="showCalendar()">â†© Retour</button>
  </div>

  <!-- Ã‰cran date de la derniÃ¨re facturation -->
  <div id="facturation-date-screen" class="container">
    <h3>Date de derniÃ¨re facturation</h3>
    <input type="text" id="last-facture-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="saveLastFactureDate()">ğŸ’¾ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">â†© Retour</button>
  </div>

<!-- Menu patient -->
<div id="patient-menu">
  <div class="menu-box">
    <button onclick="showInfoScreen()">Informations/Ordonnances/âš ï¸</button>
    <button onclick="addPresenceOffset(0)">PrÃ©sent ce jour</button>
    <button onclick="addPresenceOffset(1)">PrÃ©sent demain</button>
    <button onclick="showPresenceSelection()">SÃ©lectionner les prÃ©sences</button>
    <button onclick="closeMenuAndShowFactureList(true)">Liste sÃ©ances facturÃ©es</button>
    <button onclick="closeMenuAndShowFactureList(false)">Liste sÃ©ances non facturÃ©es</button>
    <button onclick="closeMenuAndShowFactureList()">Liste de toutes les sÃ©ances</button>
    <button onclick="showLastFactureScreen()">Date de la derniÃ¨re facturation</button>
    <button onclick="addToSpecialList()">Ajouter Ã  la liste spÃ©ciale</button>
    <button onclick="renfoDuSoir()">Renfo du soir</button>
    <button onclick="ordonnanceOK()">Ordonnance OK</button>
  </div>
</div>

    <script>
    const patientListEl = document.getElementById("patientList");
    const searchInput = document.getElementById("searchInput");
    const patientMenu = document.getElementById("patient-menu");
    const todayDateEl = document.getElementById("todayDate");
    const dayPatientList = document.getElementById("day-patient-list");

    let currentYear, currentMonth;
    let presenceYear, presenceMonth;
    let selectedPatientIndex = null;
    let presenceSelection = new Set();
    let currentDayView = null;

    // --- Utilitaires syntaxe des noms ---
function normName(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z'â€™ -]/g,"").replace(/\s+/g," ").trim();}
function samePerson(aNom,aPre,bNom,bPre){return normName(aNom)===normName(bNom) && normName(aPre)===normName(bPre);}
function mergeUniqueDates(a=[],b=[]){return Array.from(new Set([...a,...b]));}

      
      // --- Utilitaires dates ---
    function formatDate(date) {
      return date.toLocaleDateString("fr-FR");
    }

      // --- Helpers dates / clÃ©s / Ã©tat du jour ---
function todayStr(){ return formatDate(new Date()); }
function isPresentToday(p){ return Array.isArray(p.presences) && p.presences.includes(todayStr()); }
function parseDateFR(s){ const [j,m,a]=s.split("/").map(Number); return new Date(a,m-1,j); }
function addDaysFR(dateStr, n){
  const d=parseDateFR(dateStr); d.setDate(d.getDate()+n); return formatDate(d);
}
function patientKey(p){ return keyName(p.nom||"", p.prenom||""); }

// --- Stockage Ã©phÃ©mÃ¨re "facturÃ© aujourd'hui" -> ğŸ’° reste visible toute la journÃ©e ---
function getBilledTodayMap(){ try{return JSON.parse(localStorage.getItem("billedToday")||"{}");}catch(e){return {};} }
function setBilledToday(k, dateStr){ const m=getBilledTodayMap(); m[k]=dateStr; localStorage.setItem("billedToday", JSON.stringify(m)); }
function isBilledToday(k){ return getBilledTodayMap()[k]===todayStr(); }
function cleanupBilledToday(){ const m=getBilledTodayMap(); const t=todayStr(); let changed=false;
  for(const k in m){ if(m[k]!==t){ delete m[k]; changed=true; } }
  if(changed) localStorage.setItem("billedToday", JSON.stringify(m));
}

// --- Info-bulle de 2s sur un <li> ---
function showTip(li, text){
  if(!li) return;
  const old = li.querySelector(".tooltip-bubble");
  if(old) old.remove();
  const tip = document.createElement("div");
  tip.className="tooltip-bubble";
  tip.textContent = text;
  li.appendChild(tip);
  setTimeout(()=>{ tip.remove(); }, 2000);
}


    // Normaliser une date entrÃ©e par l'utilisateur (jj/mm/aa â†’ jj/mm/aaaa)
    function normalizeDate(input) {
      const parts = input.split("/");
      if (parts.length === 3) {
        let [jj, mm, aa] = parts;
        if (aa.length === 2) aa = "20" + aa;
        return `${jj.padStart(2,"0")}/${mm.padStart(2,"0")}/${aa}`;
      }
      return input;
    }

    // Afficher la date du jour
    function showToday() {
      const today = new Date();
      const options = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
      todayDateEl.textContent = today.toLocaleDateString("fr-FR", options);
    }

    // Compter les prÃ©sences pour une date
    function countPresences(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let count = 0;
      patients.forEach(p => {
        if (p.presences && p.presences.includes(dateStr)) count++;
      });
      return count;
    }
         
   // ====== Tri des patients (Ã©cran principal) ======
// Modes: "AZ" (par dÃ©faut), "ADDED_OLD", "ZA", "ADDED_NEW"
let sortMode = "AZ";

function cycleSortMode() {
  sortMode = sortMode === "AZ" ? "ADDED_OLD"
          : sortMode === "ADDED_OLD" ? "ZA"
          : sortMode === "ZA" ? "ADDED_NEW"
          : "AZ";
  renderPatients(searchInput.value);
}

function sortPatients(arr) {
  // arr = [{p, i}, ...] oÃ¹ i = index d'insertion (ordre de stockage actuel)
  const byNameAsc = (a,b) => (a.p.nom + " " + a.p.prenom).localeCompare(b.p.nom + " " + b.p.prenom, 'fr', {sensitivity:'base'});
  const byIndexAsc = (a,b) => a.i - b.i;

  const copy = arr.slice();
  if (sortMode === "AZ") copy.sort(byNameAsc);
  else if (sortMode === "ZA") copy.sort((a,b) => -byNameAsc(a,b));
  else if (sortMode === "ADDED_OLD") copy.sort(byIndexAsc);              // plus ancien en premier
  else if (sortMode === "ADDED_NEW") copy.sort((a,b) => -byIndexAsc(a,b)); // plus rÃ©cent en premier
  return copy;
}

      function makeEmoji(txt, title, onClick, extraClass=""){
  const s = document.createElement("span");
  s.className = "emoji" + (onClick ? " clickable" : "") + (extraClass ? " "+extraClass : "");
  s.textContent = txt;
  if(title) s.title = title;
  if(onClick) s.addEventListener("click", (e)=>{ e.stopPropagation(); onClick(e, s); });
  return s;
}

      
      // --- Gestion Patients ---
function renderPatients(filter = "") {
  const all = JSON.parse(localStorage.getItem("patients") || "[]");
  patientListEl.innerHTML = "";
  // met Ã  jour le total global de patients (non filtrÃ©)
const countEl = document.getElementById("patientCount");
if (countEl) countEl.textContent = `${all.length} patients`;


  // Conserve l'index original i (sert pour les tris par ordre d'ajout)
  let rows = all
    .map((p, i) => ({ p, i }))
    .filter(({ p }) => (p.nom + " " + p.prenom).toLowerCase().includes(filter.toLowerCase()));

  // Appliquer le tri selon sortMode
  rows = sortPatients(rows);

 rows.forEach(({ p, i }) => {
  const li = document.createElement("li");

  // bouton corbeille (avec confirmation dÃ©jÃ  gÃ©rÃ©e par deletePatient)
  const deleteBtn = document.createElement("button");
  deleteBtn.innerHTML = "ğŸ—‘ï¸";
  deleteBtn.className = "delete-btn";
  deleteBtn.onclick = (e) => { e.stopPropagation(); deletePatient(i); };

  const nameSpan = document.createElement("span");
  nameSpan.textContent = p.nom + " " + p.prenom;

  // IcÃ´nes en ligne (aprÃ¨s le nom), dans l'ordre demandÃ© :
  // 1) ğŸ™‹ si prÃ©sent aujourd'hui
  if (isPresentToday(p)) {
    li.appendChild(deleteBtn);
    li.appendChild(nameSpan);
    li.appendChild(makeEmoji("ğŸ™‹", "PrÃ©sent aujourd'hui"));
  } else {
    li.appendChild(deleteBtn);
    li.appendChild(nameSpan);
  }

  // 2) âš ï¸ si rejet
  if (p.rejet && p.rejet.trim() !== "") {
    li.appendChild(makeEmoji("âš ï¸", "Rejet de paiement"));
  }

  // 3) â“ si "Ordonnance non scannÃ©e" (cliquable -> bulle 2s)
  if (p.ordNonScan) {
    li.appendChild(makeEmoji("â“", "Ordonnance non scannÃ©e", (_e, self)=>{
      const info = (p.ordDetails||"").trim();
      const txt = info ? ("ordonnance du " + info) : "Ordonnance non scannÃ©e";
      showTip(li, txt);
    }));
  }

  // 4) ğŸ“‘ si "Ordonnance Ã  renouveler"
  if (p.ordRenouv) {
    li.appendChild(makeEmoji("ğŸ“‘", "Ordonnance Ã  renouveler"));
  }

  // 5) tout Ã  droite : ğŸ’¸ / ğŸ’° (facturation rapide)
  const right = document.createElement("span");
  right.className = "right-edge";

  const k = patientKey(p);
  const hasNonFact = nonFactCount(p) > 0;
  if (hasNonFact || isBilledToday(k)) {
    const billedNow = isBilledToday(k);
    const icon = billedNow ? "ğŸ’°" : "ğŸ’¸";
    const title = billedNow ? "FacturÃ© aujourd'hui" : "Facturer jusqu'Ã  aujourd'hui";
    const billEmoji = makeEmoji(icon, title, billedNow ? null : ()=>{
  const ok = confirm(`Confirmer la facturation des sÃ©ances de ${p.nom} ${p.prenom} ?`);
  if(!ok) return;

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const q = patients[i];
  if (!q) return;
  q.lastFactureDate = todayStr();
  patients[i] = q;
  localStorage.setItem("patients", JSON.stringify(patients));

  setBilledToday(k, todayStr()); // force ğŸ’° jusqu'Ã  minuit
  renderPatients(searchInput.value);
  updatePinButton();
});

    right.appendChild(billEmoji);
  }

  li.appendChild(right);

  // Ouvrir le menu patient au clic
  li.onclick = () => showPatientMenu(i);
  patientListEl.appendChild(li);
});
}


    function savePatient() {
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      if (!nom || !prenom) {
        alert("Veuillez remplir Nom et PrÃ©nom");
        return;
      }
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
patients.push({
  nom, prenom,
  phone:"", rejet:"", notes:"",
  presences:[],
  lastFactureDate:null,
  // Nouveaux champs :
  ordNonScan:false,
  ordRenouv:false,
  ordDetails:""
});

      localStorage.setItem("patients", JSON.stringify(patients));
      document.getElementById("nom").value = "";
      document.getElementById("prenom").value = "";
      showMainScreen();
      renderPatients(searchInput.value);
    }

function deletePatient(index) {
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[index];
  if(!p) return;
  const ok = confirm(`Supprimer dÃ©finitivement ${p.nom} ${p.prenom} ?`);
  if(!ok) return;
  patients.splice(index, 1);
  localStorage.setItem("patients", JSON.stringify(patients));
  renderPatients(searchInput.value);
}


    // --- Navigation ---
    function showAddScreen() {
  hideAll();
  document.getElementById("add-screen").style.display = "block";

  // reset OCR zone de l'Ã©cran d'ajout
  document.getElementById("add-ocr-results").innerHTML = "";
  document.getElementById("add-ocr-import-btn").style.display = "none";
  ["add-ocr-file-1","add-ocr-file-2","add-ocr-file-3","add-ocr-file-4","add-ocr-file-5"].forEach(id=>{
    const el = document.getElementById(id); if (el) el.value = "";
  });

  // NOM => MAJUSCULES en direct
  const nomInput = document.getElementById("nom");
  if (nomInput && !nomInput.__upperBound) {
    nomInput.addEventListener("input", (e)=> { e.target.value = e.target.value.toUpperCase(); });
    nomInput.__upperBound = true; // Ã©viter double binding
  }
}

    function showMainScreen() {
      hideAll();
      document.getElementById("main-screen").style.display = "block";
      renderPatients(searchInput.value);
      updatePinButton();
    }

function clearMainSearch(){
  searchInput.value = "";
  renderPatients("");
}
      
    function showCalendar() {
      hideAll();
      document.getElementById("calendar-screen").style.display = "block";
      renderCalendar();
    }
  
      function showInfoScreen() {
  patientMenu.style.display = "none";
  hideAll();
  document.getElementById("info-screen").style.display = "block";

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[selectedPatientIndex];

  document.getElementById("info-title").textContent = p.nom + " " + p.prenom;

  // NOUVEAU : prÃ©remplissage des champs nom/prÃ©nom
  document.getElementById("info-nom").value = p.nom || "";
  document.getElementById("info-prenom").value = p.prenom || "";

  document.getElementById("info-phone").value = p.phone || "";
  document.getElementById("info-rejet").value = p.rejet || "";
  document.getElementById("info-notes").value = p.notes || "";

  // --- Ordonnances (mutuellement exclusives) ---
const cbNon = document.getElementById("info-ord-nonscan");
const cbRen = document.getElementById("info-ord-renouv");
const det   = document.getElementById("info-ord-details");

cbNon.checked = !!p.ordNonScan;
cbRen.checked = !!p.ordRenouv;
det.value     = p.ordDetails || "";

// affichage conditionnel du champ "ordonnance du ..."
det.style.display = cbNon.checked ? "block" : "none";

// binder une seule fois
if(!cbNon.__bound){
  cbNon.addEventListener("change", ()=>{
    if(cbNon.checked){ cbRen.checked = false; det.style.display = "block"; }
    else{ det.style.display = "none"; }
  });
  cbNon.__bound = true;
}
if(!cbRen.__bound){
  cbRen.addEventListener("change", ()=>{
    if(cbRen.checked){ cbNon.checked = false; det.style.display = "none"; }
  });
  cbRen.__bound = true;
}
      
}

    function showPresenceSelection() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("presence-screen").style.display = "block";

      const today = new Date();
      presenceYear = today.getFullYear();
      presenceMonth = today.getMonth();
      presenceSelection = new Set(
        (JSON.parse(localStorage.getItem("patients"))[selectedPatientIndex].presences || [])
      );
      renderPresenceCalendar();
    }
    function showPresenceByDate() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("presence-date-screen").style.display = "block";
    }
    function showDayScreen(dateStr) {
      hideAll();
      document.getElementById("day-screen").style.display = "block";
      updateDayTitle(dateStr);
      currentDayView = dateStr;
      renderDayPatients(dateStr);
    }
    function showLastFactureScreen() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("facturation-date-screen").style.display = "block";
    }
    function showFactureScreen() {
      hideAll();
      document.getElementById("facture-screen").style.display = "block";
      renderFactureList();
    }
    function showOcrScreen() {
      hideAll();
      document.getElementById("ocr-import-screen").style.display = "block";
    }
    function hideOcrScreen() {
      hideAll();
      document.getElementById("main-screen").style.display = "block";
    }

    function hideAll() {
      ["main-screen","add-screen","calendar-screen","info-screen",
       "presence-screen","presence-date-screen","day-screen",
       "facturation-date-screen","facture-screen","ocr-import-screen","special-screen","patient-sessions-screen"]
       .forEach(id => { document.getElementById(id).style.display="none"; });
    }
          // --- Menu patient ---
    function showPatientMenu(index) {
      selectedPatientIndex = index;
      patientMenu.style.display = "flex";
    }
function closeMenuAndShowFactureList(mode) {
  patientMenu.style.display = "none";
  showFactureList(mode); // ta fonction qui ouvre l'Ã©cran des sÃ©ances
}
      patientMenu.addEventListener("click", (e) => {
      if (e.target === patientMenu) {
        patientMenu.style.display = "none";
      }
    });

function ordonnanceOK(){
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  if (selectedPatientIndex == null) return;
  const p = patients[selectedPatientIndex];
  if (!p) return;

  // DÃ©cocher les deux Ã©tats dâ€™ordonnance
  p.ordNonScan = false;
  p.ordRenouv  = false;
  // On laisse p.ordDetails tel quel pour mÃ©moire (tu peux le vider si tu prÃ©fÃ¨res).

  patients[selectedPatientIndex] = p;
  localStorage.setItem("patients", JSON.stringify(patients));

  // Ferme le menu
  patientMenu.style.display = "none";

  // RafraÃ®chir l'Ã©cran courant (main vs spÃ©ciale)
  const specialVisible = document.getElementById("special-screen").style.display === "block";
  if (specialVisible) {
    renderSpecialList();
  } else {
    renderPatients(searchInput.value);
  }
  updatePinButton();

  // (Optionnel) si l'Ã©cran "Informations" est ouvert, dÃ©cocher visuellement
  if (document.getElementById("info-screen").style.display === "block") {
    const cbNon = document.getElementById("info-ord-nonscan");
    const cbRen = document.getElementById("info-ord-renouv");
    const det   = document.getElementById("info-ord-details");
    if (cbNon) cbNon.checked = false;
    if (cbRen) cbRen.checked = false;
    if (det)   det.style.display = "none";
  }
}
      
    // --- Sauvegarde infos ---
 function saveInfo() {
  let patients = JSON.parse(localStorage.getItem("patients") || "[]");
  if (selectedPatientIndex === null) return;

  const idx = selectedPatientIndex;
  const newNom = (document.getElementById("info-nom").value || "").trim();
  const newPrenom = (document.getElementById("info-prenom").value || "").trim();
  if (!newNom && !newPrenom) {
    alert("Veuillez renseigner au moins Nom ou PrÃ©nom.");
    return;
  }

  const p = patients[idx];
  const prevNom = p.nom, prevPrenom = p.prenom;

  // PrÃ©pare l'objet Ã  jour (sans toucher aux sÃ©ances/notes)
  p.nom = newNom || p.nom;
  p.prenom = newPrenom || p.prenom;
  p.phone = (document.getElementById("info-phone").value || "").trim();
  p.rejet = (document.getElementById("info-rejet").value || "").trim();
  p.notes = (document.getElementById("info-notes").value || "").trim();

  // --- Sauvegarde ordonnances ---
const cbNon = document.getElementById("info-ord-nonscan");
const cbRen = document.getElementById("info-ord-renouv");
const det   = document.getElementById("info-ord-details");

p.ordNonScan = !!cbNon.checked;
p.ordRenouv  = !!cbRen.checked;
p.ordDetails = (det.value || "").trim();

// garantir l'exclusivitÃ© aussi cÃ´tÃ© data
if(p.ordNonScan && p.ordRenouv) p.ordRenouv = false;
if(!p.ordNonScan) p.ordDetails = (p.ordDetails||""); // on conserve ce que tu as saisi, mÃªme masquÃ©
 

  // Cherche un autre patient EXACTEMENT identique aprÃ¨s renommage
  const dupIndex = patients.findIndex((q, i) =>
    i !== idx && samePerson(q.nom, q.prenom, p.nom, p.prenom)
  );

  if (dupIndex !== -1) {
    const q = patients[dupIndex];
    const ok = confirm(
      `Un autre patient porte dÃ©jÃ  ce nom :\n\n`+
      `A) ${p.nom} ${p.prenom}\n`+
      `B) ${q.nom} ${q.prenom}\n\n`+
      `Souhaites-tu FUSIONNER leurs sÃ©ances et conserver un seul patient ?`
    );
    if (ok) {
      // Fusionne les prÃ©sences et conserve p (celui qu'on Ã©dite)
      p.presences = mergeUniqueDates(p.presences, q.presences);
      // Option : garder les infos non vides de q si p est vide
      if (!p.phone && q.phone) p.phone = q.phone;
      if (!p.rejet && q.rejet) p.rejet = q.rejet;
      if (!p.notes && q.notes) p.notes = q.notes;
      // lastFactureDate : garde la plus rÃ©cente
      if (q.lastFactureDate && (!p.lastFactureDate || compareDates(q.lastFactureDate, p.lastFactureDate) > 0)) {
        p.lastFactureDate = q.lastFactureDate;
      }
      // Supprime lâ€™autre fiche
      patients.splice(dupIndex, 1);
      // Recalcule selectedPatientIndex si besoin
      selectedPatientIndex = patients.indexOf(p);
    }
  }

  patients[selectedPatientIndex] = p;
  localStorage.setItem("patients", JSON.stringify(patients));
  showMainScreen();
  renderPatients(searchInput.value);
}


    // --- Ajout prÃ©sence rapide ---
    function addPresenceOffset(offset) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      const d = new Date();
      d.setDate(d.getDate() + offset);
      const dateStr = formatDate(d);
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      patientMenu.style.display = "none";
    }

    // --- Ajout prÃ©sence par date ---
    function savePresenceByDate() {
      let dateStr = document.getElementById("presence-date").value.trim();
      if (!dateStr) return;
      dateStr = normalizeDate(dateStr);
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }
          // --- Calendrier global ---
    function renderCalendar() {
      const titleEl = document.getElementById("calendar-title");
      const gridEl = document.getElementById("calendar-grid");

      const today = new Date();
      if (currentYear === undefined) {
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
      }

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const monthName = firstDay.toLocaleString("fr-FR", { month: "long" });

      titleEl.textContent = monthName + " " + currentYear;
      gridEl.innerHTML = "";

      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for (let i = 0; i < startDay; i++) {
        gridEl.appendChild(document.createElement("div"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(date);
        const count = countPresences(dateStr);

        const dayEl = document.createElement("div");
        dayEl.className = "calendar-day";
        dayEl.textContent = d;

        if (count > 40) dayEl.classList.add("red");
        else if (count >= 35) dayEl.classList.add("orange");
        else if (count >= 5) dayEl.classList.add("green");
        else if (count >= 1) dayEl.classList.add("blue");

        // Pastille facturation
        const pct = facturePercentage(dateStr);
        if (pct !== null) {
          const pastille = document.createElement("div");
          pastille.className = "pastille";
          if (pct === 0) pastille.style.background = "darkgreen";
          else if (pct > 50) pastille.style.background = "red";
          else if (pct > 0) pastille.style.background = "orange";
          dayEl.appendChild(pastille);
        }

        dayEl.onclick = () => showDayScreen(dateStr);
        gridEl.appendChild(dayEl);
      }
    }
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    // --- Calendrier prÃ©sences (multi sÃ©lection) ---
    function renderPresenceCalendar() {
      const titleEl = document.getElementById("presence-title");
      const gridEl = document.getElementById("presence-grid");

      const firstDay = new Date(presenceYear, presenceMonth, 1);
      const lastDay = new Date(presenceYear, presenceMonth + 1, 0);
      const monthName = firstDay.toLocaleString("fr-FR", { month: "long" });

      titleEl.textContent = monthName + " " + presenceYear;
      gridEl.innerHTML = "";

      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for (let i = 0; i < startDay; i++) {
        gridEl.appendChild(document.createElement("div"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(presenceYear, presenceMonth, d);
        const dateStr = formatDate(date);
        const dayEl = document.createElement("div");
        dayEl.className = "calendar-day";
        dayEl.textContent = d;

        if (presenceSelection.has(dateStr)) {
          dayEl.classList.add("selected");
        }

        dayEl.onclick = () => {
          if (presenceSelection.has(dateStr)) {
            presenceSelection.delete(dateStr);
            dayEl.classList.remove("selected");
          } else {
            presenceSelection.add(dateStr);
            dayEl.classList.add("selected");
          }
        };

        gridEl.appendChild(dayEl);
      }
    }
    function prevPresenceMonth(){
      presenceMonth--;
      if (presenceMonth < 0) { presenceMonth = 11; presenceYear--; }
      renderPresenceCalendar();
    }
    function nextPresenceMonth(){
      presenceMonth++;
      if (presenceMonth > 11) { presenceMonth = 0; presenceYear++; }
      renderPresenceCalendar();
    }
    function savePresenceSelection() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].presences = Array.from(presenceSelection);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }
          // --- Liste des patients d'une journÃ©e ---
    function updateDayTitle(dateStr) {
      const total = countPresences(dateStr);
      document.getElementById("day-title").textContent =
        "PrÃ©sents le " + dateStr + " â€” " + total + " patient(s)";
    }

// Tri du day-screen
let daySortMode = "AZ"; // Aâ†’Z par dÃ©faut

function cycleDaySortMode() {
  daySortMode = daySortMode === "AZ" ? "ADDED_OLD"
              : daySortMode === "ADDED_OLD" ? "ZA"
              : daySortMode === "ZA" ? "ADDED_NEW"
              : "AZ";
  if (currentDayView) renderDayPatients(currentDayView);
}

// utilitaire de tri paramÃ©trable (rÃ©utilise la logique de l'Ã©cran principal)
function sortPatientsByMode(rows, mode) {
  const byNameAsc  = (a,b) => (a.p.nom + " " + a.p.prenom).localeCompare(b.p.nom + " " + b.p.prenom, 'fr', {sensitivity:'base'});
  const byIndexAsc = (a,b) => a.i - b.i;

  const copy = rows.slice();
  if (mode === "AZ") copy.sort(byNameAsc);
  else if (mode === "ZA") copy.sort((a,b) => -byNameAsc(a,b));
  else if (mode === "ADDED_OLD") copy.sort(byIndexAsc);
  else if (mode === "ADDED_NEW") copy.sort((a,b) => -byIndexAsc(a,b));
  return copy;
}

      
  function renderDayPatients(dateStr) {
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const q = (document.getElementById("daySearchInput")?.value || "").toLowerCase();

  // Construire rows {p, i} pour ceux prÃ©sents ce jour
  let rows = patients
    .map((p, i) => ({ p, i }))
    .filter(({p}) => p.presences && p.presences.includes(dateStr))
    .filter(({p}) => (p.nom + " " + p.prenom).toLowerCase().includes(q));

  // Tri selon daySortMode (dÃ©jÃ  dÃ©fini dans ton code)
  rows = sortPatientsByMode(rows, daySortMode);

  dayPatientList.innerHTML = "";
  rows.forEach(({p, i}) => {
    const li = document.createElement("li");

    // Corbeille (supprime la prÃ©sence du jour) + confirmation
    const delBtn = document.createElement("button");
    delBtn.textContent = "ğŸ—‘ï¸";
    delBtn.className = "delete-btn";
    delBtn.onclick = (e) => {
      e.stopPropagation();
      const ok = confirm(`Retirer ${p.nom} ${p.prenom} des prÃ©sents du ${dateStr} ?`);
      if(!ok) return;
      p.presences = (p.presences||[]).filter(d => d !== dateStr);
      patients[i] = p;
      localStorage.setItem("patients", JSON.stringify(patients));
      renderDayPatients(dateStr);
      updateDayTitle(dateStr);
    };

    const span = document.createElement("span");
    span.textContent = p.nom + " " + p.prenom;

    // FlÃ¨che â¡ï¸ collÃ©e au bord droit : â€œreporter au lendemainâ€
    const right = document.createElement("span");
    right.className = "right-edge";
    const move = makeEmoji("â¡ï¸", "Reporter au lendemain", ()=>{
      const tomorrow = addDaysFR(dateStr, 1);
      p.presences = (p.presences || []).filter(d => d !== dateStr);
      if(!p.presences.includes(tomorrow)) p.presences.push(tomorrow);
      patients[i] = p;
      localStorage.setItem("patients", JSON.stringify(patients));
      renderDayPatients(dateStr);
      updateDayTitle(dateStr);
    });
    right.appendChild(move);

    li.appendChild(delBtn);
    li.appendChild(span);
    li.appendChild(right);
    dayPatientList.appendChild(li);
  });

  // Ã©couteur de recherche (une seule fois)
  const inp = document.getElementById("daySearchInput");
  if (inp && !inp.__bound) {
    inp.addEventListener("input", () => renderDayPatients(dateStr));
    inp.__bound = true;
  }
}


    // --- Facturation ---
    function saveLastFactureDate() {
      const dateStr = normalizeDate(document.getElementById("last-facture-date").value.trim());
      if (!dateStr) return;
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].lastFactureDate = dateStr;
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    // Retourne % de sÃ©ances non facturÃ©es pour une date
    function facturePercentage(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let total = 0, nonFact = 0;
      patients.forEach(p => {
        if (p.presences && p.presences.includes(dateStr)) {
          total++;
          if (!p.lastFactureDate || compareDates(dateStr, p.lastFactureDate) > 0) {
            nonFact++;
          }
        }
      });
      if (total === 0) return null;
      return (nonFact / total) * 100;
    }

    function compareDates(d1, d2) {
      const [j1,m1,a1] = d1.split("/").map(Number);
      const [j2,m2,a2] = d2.split("/").map(Number);
      const date1 = new Date(a1,m1-1,j1);
      const date2 = new Date(a2,m2-1,j2);
      if (date1 > date2) return 1;
      if (date1 < date2) return -1;
      return 0;
    }

    // Liste patients "Ã€ facturer"
function renderFactureList() {
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const ul = document.getElementById("facture-list");
  const titleEl = document.getElementById("facture-title");
  ul.innerHTML = "";

  const tStr = formatDate(new Date()); // today (on ignore les sÃ©ances > aujourd'hui)

  // Calcule le nonFact par patient (en excluant le futur)
  const all = patients.map(p => {
    let nonFact = 0;
    (p.presences || []).forEach(dateStr => {
      if (compareDates(dateStr, tStr) <= 0) {
        if (!p.lastFactureDate || compareDates(dateStr, p.lastFactureDate) > 0) {
          nonFact++;
        }
      }
    });
    return { ...p, nonFact };
  }).filter(p => p.nonFact > 0);

  // Total global + estimation â‚¬
  const totalGlobal = all.reduce((sum, p) => sum + p.nonFact, 0);
  if (titleEl) titleEl.textContent = `Patients avec sÃ©ances non facturÃ©es (${totalGlobal})`;
  const estimateEl = document.getElementById("facture-estimate");
  if (estimateEl) {
    const euros = Math.round(totalGlobal * 18.2);
    estimateEl.textContent = `soit environ ${euros.toLocaleString('fr-FR')} â‚¬ Ã  rÃ©cupÃ©rer`;
  }

  // Tri : plus de nonFact d'abord, puis alpha
  all.sort((a,b) => (b.nonFact - a.nonFact) ||
    (a.nom + " " + a.prenom).localeCompare(b.nom + " " + b.prenom, 'fr', {sensitivity:'base'}));

  // Rendu avec Ã©moji â“/ğŸ“‘ aprÃ¨s le nom, et ğŸ’¸ tout Ã  droite
  all.forEach(p => {
    const li = document.createElement("li");

    const nameSpan = document.createElement("span");
    nameSpan.textContent = `${p.nom} ${p.prenom} (${p.nonFact})`;
    li.appendChild(nameSpan);

    // â“ si "Ordonnance non scannÃ©e"
    if (p.ordNonScan) {
      li.appendChild(makeEmoji("â“", "Ordonnance non scannÃ©e", (_e,self)=>{
        const info = (p.ordDetails||"").trim();
        const txt = info ? ("ordonnance du " + info) : "Ordonnance non scannÃ©e";
        showTip(li, txt);
      }));
    }

    // ğŸ“‘ si "Ordonnance Ã  renouveler"
    if (p.ordRenouv) {
      li.appendChild(makeEmoji("ğŸ“‘", "Ordonnance Ã  renouveler"));
    }

    // ğŸ’¸ tout Ã  droite
    const right = document.createElement("span");
    right.className = "right-edge";

    const billEmoji = makeEmoji("ğŸ’¸", "Facturer jusqu'Ã  aujourd'hui", ()=>{
  const ok = confirm(`Confirmer la facturation des sÃ©ances de ${p.nom} ${p.prenom} ?`);
  if(!ok) return;

  const key = keyName(p.nom, p.prenom);
  const idx = patients.findIndex(x => keyName(x.nom, x.prenom) === key);
  if (idx !== -1) {
    patients[idx].lastFactureDate = formatDate(new Date());
    localStorage.setItem("patients", JSON.stringify(patients));

    // Ajout du marqueur temporaire (ğŸ’° jusquâ€™Ã  minuit)
    setBilledToday(key, todayStr());
  }

  // RafraÃ®chir les Ã©crans
  renderFactureList();              // supprime de "Ã  facturer"
  renderPatients(searchInput.value); // met Ã  jour principal (avec ğŸ’°)
  updatePinButton();
});


    right.appendChild(billEmoji);
    li.appendChild(right);

    // (Option) Couleur indicative selon le nombre de non facturÃ©es (comme avant)
    if (p.nonFact > 20)        li.style.color = "red";
    else if (p.nonFact >= 10)  li.style.color = "orange";
    else if (p.nonFact >= 5)   li.style.color = "yellow";
    else if (p.nonFact >= 2)   li.style.color = "green";
    else                       li.style.color = "skyblue";

    ul.appendChild(li);
  });
}


      // ====== Listes de sÃ©ances d'un patient (facturÃ©es / non facturÃ©es / toutes) ======
// filterMode: true = facturÃ©es, false = non facturÃ©es (<= aujourd'hui), undefined = toutes (inclut futur en bleu ciel)
function showFactureList(filterMode) {
  if (selectedPatientIndex === null) return;

  hideAll();
  document.getElementById("patient-sessions-screen").style.display = "block";

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[selectedPatientIndex];
  const ul = document.getElementById("patient-sessions-list");
  const titleEl = document.getElementById("patient-sessions-title");
  ul.innerHTML = "";

  const todayStr = formatDate(new Date());
  const last = p.lastFactureDate ? normalizeDate(p.lastFactureDate) : null;

  // Toutes les prÃ©sences triÃ©es chronologiquement ASC
  const sessions = (p.presences || []).slice().sort((a,b) => {
    const [ja,ma,aa]=a.split("/").map(Number);
    const [jb,mb,ab]=b.split("/").map(Number);
    return new Date(aa,ma-1,ja) - new Date(ab,mb-1,jb);
  });

  // Helper non facturÃ©es (en ignorant FUTUR)
  const nonFactCount = sessions.reduce((cnt, d) => {
    const isPastOrToday = compareDates(d, todayStr) <= 0;
    const isNonFact = !last || compareDates(d, last) > 0;
    return cnt + (isPastOrToday && isNonFact ? 1 : 0);
  }, 0);

  // Titre selon mode, avec (total non facturÃ©es) entre parenthÃ¨ses
  const base =
    filterMode === true ? "SÃ©ances facturÃ©es"
    : filterMode === false ? "SÃ©ances non facturÃ©es"
    : "Toutes les sÃ©ances";
  titleEl.textContent = `${p.nom} ${p.prenom} â€” ${base} (${nonFactCount})`;

  // Filtrage selon mode
  const filtered = sessions.filter(d => {
    if (filterMode === true) {        // facturÃ©es
      return last && compareDates(d, last) <= 0;
    }
    if (filterMode === false) {       // non facturÃ©es (<= aujourd'hui)
      const isPastOrToday = compareDates(d, todayStr) <= 0;
      const isNonFact = !last || compareDates(d, last) > 0;
      return isPastOrToday && isNonFact;
    }
    return true; // toutes
  });

  // Rendu: futur = bleu ciel si on est en "toutes"
  filtered.forEach(d => {
    const li = document.createElement("li");
    li.textContent = d;

    if (filterMode === undefined && compareDates(d, todayStr) > 0) {
      li.style.color = "skyblue"; // futur distinct en "toutes"
    } else {
      // Colorer facturation (optionnel, neutre sinon)
      const isNonFact = !last || compareDates(d, last) > 0;
      // Tu peux colorer si tu veux, ici on laisse blanc pour facturÃ©es/non
      // li.style.color = isNonFact ? "#ffd27f" : "#fff";
    }

    ul.appendChild(li);
  });
}


    // --- OCR Doctolib ---
    async function processOcrFiles() {
      const files = [
        document.getElementById("ocr-file-1").files[0],
        document.getElementById("ocr-file-2").files[0],
        document.getElementById("ocr-file-3").files[0],
        document.getElementById("ocr-file-4").files[0],
        document.getElementById("ocr-file-5").files[0]
      ].filter(f => f);

      if (files.length === 0) {
        alert("Veuillez sÃ©lectionner au moins une capture.");
        return;
      }

      document.getElementById("ocr-results").innerHTML = "ğŸ” OCR en cours...";
      let rawText = "";

      for (const file of files) {
        const { data: { text } } = await Tesseract.recognize(file, "fra");
        rawText += "\n" + text;
      }

      const cleaned = cleanOcrText(rawText);
      showOcrResults(cleaned);
    }

// ===== OCR "PrÃ©sences" (dans l'Ã©cran SÃ©lectionner les prÃ©sences) =====
const FR_MONTHS_ALLOWED = {
  "janv.":1, "fÃ©vr.":2, "fevr.":2,
  "mars":3, "avr.":4, "mai":5, "juin":6,
  "juil.":7, "aoÃ»t":8, "aout":8,
  "sept.":9, "oct.":10, "nov.":11, "dÃ©c.":12, "dec.":12
};

function normTxt(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ").trim();
}

// Ex: "mar. 25 sept. 2025" ou "lun. 3 mai 2025"
function extractPresenceDates(text){
  const results = [];
  const seen = new Set();
  const re = /(lun|mar|mer|jeu|ven|sam|dim)\.\s+(\d{1,2})\s+([A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿\.]+)\s+(\d{4})/g;
  let m;
  while ((m = re.exec(text)) !== null) {
    const dayNum = parseInt(m[2], 10);
    const keyMonth = normTxt(m[3].trim());
    const yearNum = parseInt(m[4], 10);
    if (!(keyMonth in FR_MONTHS_ALLOWED)) continue;
    const mm = FR_MONTHS_ALLOWED[keyMonth];
    if (dayNum < 1 || dayNum > 31) continue;
    const dd = String(dayNum).padStart(2,"0");
    const MM = String(mm).padStart(2,"0");
    const yyyy = String(yearNum);
    const dateStr = `${dd}/${MM}/${yyyy}`;
    if (!seen.has(dateStr)) { seen.add(dateStr); results.push(dateStr); }
  }
  results.sort((a,b)=>{
    const [ja,ma,aa]=a.split("/").map(Number);
    const [jb,mb,ab]=b.split("/").map(Number);
    return new Date(aa,ma-1,ja) - new Date(ab,mb-1,jb);
  });
  return results;
}

async function processPresenceOcrFiles(){
  const files = [
    document.getElementById("pres-ocr-file-1").files[0],
    document.getElementById("pres-ocr-file-2").files[0],
    document.getElementById("pres-ocr-file-3").files[0],
    document.getElementById("pres-ocr-file-4").files[0],
    document.getElementById("pres-ocr-file-5").files[0],
  ].filter(Boolean);
  if (files.length === 0){ alert("SÃ©lectionne au moins une capture Doctolib."); return; }

  const zone = document.getElementById("pres-ocr-results");
  const btnImport = document.getElementById("pres-ocr-import-btn");
  zone.innerHTML = "ğŸ” OCR en cours...";
  btnImport.style.display = "none";

  let raw = "";
  for (const f of files){
    const { data:{ text } } = await Tesseract.recognize(f, "fra");
    raw += "\n" + text;
  }
  const dates = extractPresenceDates(raw);
  showPresenceOcrResults(dates);
}

function showPresenceOcrResults(dates){
  const zone = document.getElementById("pres-ocr-results");
  zone.innerHTML = "";
  if (!dates || dates.length === 0){
    zone.innerHTML = "<p>Aucune date valide trouvÃ©e.</p>";
    return;
  }
  const ul = document.createElement("ul");
  ul.className = "ocr-list";
  dates.forEach((d, idx)=>{
    const li = document.createElement("li");
    const id = "presocr_"+idx;
    const cb = document.createElement("input");
    cb.type = "checkbox"; cb.id = id; cb.value = d; cb.checked = true;
    const label = document.createElement("label");
    label.className = "ocr-name"; label.setAttribute("for", id); label.textContent = d;
    li.appendChild(cb); li.appendChild(label); ul.appendChild(li);
  });
  zone.appendChild(ul);
  document.getElementById("pres-ocr-import-btn").style.display = "inline-block";
}

function importPresenceDatesChecked(){
  if (selectedPatientIndex === null) return;
  const zone = document.getElementById("pres-ocr-results");
  const cbs = zone.querySelectorAll("input[type=checkbox]:checked");
  const chosen = Array.from(cbs).map(cb => cb.value);
  if (chosen.length === 0){ alert("Coche au moins une date Ã  ajouter."); return; }

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[selectedPatientIndex] || { presences:[] };
  let changed = false;

  chosen.forEach(dateStr=>{
    if (!p.presences.includes(dateStr)){
      p.presences.push(dateStr);
      presenceSelection.add(dateStr);
      changed = true;
    }
  });

  if (changed){
    patients[selectedPatientIndex] = p;
    localStorage.setItem("patients", JSON.stringify(patients));
    renderPresenceCalendar();
  }
  alert("Import de dates terminÃ©.");
  document.getElementById("pres-ocr-import-btn").style.display = "none";
  document.getElementById("pres-ocr-results").innerHTML = "";
}

      
    // Nettoyage du texte OCR 
    function cleanOcrText(text) {
  // 1) Nettoyage large des lignes
  const lines = text.split("\n")
    .map(l => l.replace(/\d{1,2}[:h]\d{2}/g,""))             // heures
    .map(l => l.replace(/\d{1,2}\/\d{1,2}\/\d{2,4}/g,""))     // dates
    .map(l => l.replace(/[|@+]/g," "))                        // symboles parasites
    .map(l => l.replace(/[^A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿ \-']/g, " "))      // garde lettres/accents/espaces/tirets/'
    .map(l => l.replace(/\s+/g," ").trim())
    .filter(l => l.length > 2);

  const results = new Set();

  for (const raw of lines) {
    const normalized = normalizeOcrName(raw);
    if (normalized) results.add(normalized);
  }
  return Array.from(results);
}

// Extrait strictement "NOM PrÃ©nom" Ã  partir d'une ligne
// Extrait strictement "NOM PrÃ©nom" Ã  partir d'une ligne OCR
function normalizeOcrName(line) {
  if (!line) return null;

  // Tokenisation en conservant accents, tirets et apostrophes
  const tokens = line.split(/\s+/).filter(Boolean);

  // SÃ©parer les tokens UPPERCASE (NOM) et les tokens CapitalisÃ©s (PrÃ©nom)
  const up = [];
  let first = [];

  for (const t of tokens) {
    const hasLetter = /[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿]/.test(t);
    if (!hasLetter) continue;

    const isUpper = t === t.toUpperCase() && t.length >= 2;
    const isCap   = /^[A-ZÃ€-Ã–Ã˜-Ã][a-zÃ -Ã¶Ã¸-Ã¿'â€™-]+$/.test(t); // PrÃ©nom capitalisÃ© (accents ok)

    if (isUpper) up.push(t);
    else if (isCap) first.push(t);
  }

  // Exclure explicitement "Bon" dÃ©tectÃ© comme prÃ©nom (ex: "DESUERT Bon ValÃ©rie" â†’ "DESUERT ValÃ©rie")
  first = first.filter(tok => tok.toLowerCase() !== "bon");

  // Il faut au moins un NOM (upper) et au moins un PrÃ©nom (capitalisÃ©)
  if (up.length === 0 || first.length === 0) return null;

  // Cas "NOM NOM PrÃ©nom" : si les deux premiers NOM sont identiques (ignorer tirets/â€™)
  // on compacte en ne gardant qu'un seul NOM.
  let surname = up[0];
  if (up.length >= 2) {
    const n1 = up[0].replace(/[-â€™']/g, "");
    const n2 = up[1].replace(/[-â€™']/g, "");
    if (n1 === n2) surname = up[0];
  }

  // PrÃ©nom = concatÃ©nation des tokens capitalisÃ©s restants
  const firstname = first.join(" ");

  // Filtre final : longueur minimale
  if (surname.length < 3 || firstname.length < 3) return null;

  return `${surname} ${firstname}`;
}



function showOcrResults(lines) {
  const div = document.getElementById("ocr-results");
  div.innerHTML = "";

  if (!lines || lines.length === 0) {
    div.innerHTML = "<p>Aucun patient dÃ©tectÃ©.</p>";
    return;
  }

  const ul = document.createElement("ul");
  let any = false;

  lines.forEach(fullName => {
    const parts = String(fullName || "").trim().split(/\s+/);
    if (parts.length < 2) return; // pas de prÃ©nom â†’ on ignore

    const surname   = (parts[0] || "").trim();
    const firstname = (parts.slice(1).join(" ") || "").trim();

    // garde-fou dâ€™affichage : ignorer si < 3 caractÃ¨res pour NOM ou PrÃ©nom
    if (surname.length < 3 || firstname.length < 3) return;

    const li = document.createElement("li");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = true; // logique â€œPrÃ©vusâ€ : tout cochÃ© par dÃ©faut
    cb.value = fullName;

    li.appendChild(cb);
    li.appendChild(document.createTextNode(" " + fullName));
    ul.appendChild(li);
    any = true;
  });

  if (!any) {
    div.innerHTML = "<p>Aucun patient dÃ©tectÃ©.</p>";
    return;
  }

  div.appendChild(ul);
  document.getElementById("ocr-import-confirm").style.display = "inline-block";
}


    document.getElementById("ocr-process-btn").addEventListener("click", processOcrFiles);

   document.getElementById("ocr-import-confirm").addEventListener("click", () => {
  const div = document.getElementById("ocr-results");
  const cbs = div.querySelectorAll("input[type=checkbox]:checked");
  const selectedNames = Array.from(cbs).map(cb => cb.value);

  // Date de prÃ©sence (aujourd'hui par dÃ©faut)
  let dateStr = document.getElementById("ocr-presence-date").value.trim();
  if (!dateStr) dateStr = formatDate(new Date());
  else dateStr = normalizeDate(dateStr);

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");

  // Set de clÃ©s normalisÃ©es existantes (utile si tu veux lâ€™utiliser ailleurs)
  const existingKeys = new Set(patients.map(p => keyName(p.nom, p.prenom)));

  selectedNames.forEach(name => {
    // cleanOcrText() renvoie dÃ©jÃ  "NOM PrÃ©nom" strict â†’ split simple
    const parts = name.split(" ");
    const nom = parts[0] || "";
    const prenom = parts.slice(1).join(" ") || "";

    const k = keyName(nom, prenom);

    // 1) Match EXACT par clÃ© normalisÃ©e
    let match = patients.find(p => keyName(p.nom, p.prenom) === k);

    // 2) Sinon, fallback flou (plus strict que ton 0.7 â†’ 0.85)
    if (!match) {
      match = patients.find(p => similarity(p.nom + " " + p.prenom, name) > 0.85);
    }

    if (!match) {
      // CrÃ©e le patient et ajoute la prÃ©sence du jour choisi
      patients.push({
        nom,
        prenom,
        phone: "",
        rejet: "",
        notes: "",
        presences: [dateStr],
        lastFactureDate: null
      });
    } else {
      // Ajoute la prÃ©sence si elle nâ€™existe pas
      if (!match.presences.includes(dateStr)) match.presences.push(dateStr);
    }
  });

  localStorage.setItem("patients", JSON.stringify(patients));
  hideOcrScreen();
  showMainScreen();
});

document.getElementById("add-ocr-process-btn").addEventListener("click", processAddOcrFiles);
document.getElementById("add-ocr-import-btn").addEventListener("click", importAddOcrSelection);
      
function keyName(nom, prenom) {
  return (nom + "|" + prenom).toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // retire accents
    .replace(/[^a-z\-| ]/g,"")                        // garde lettres, espaces, tirets, |
    .replace(/\s+/g," ").trim();
}

      
    // Fonction de similaritÃ© floue (Levenshtein)
    function similarity(s1, s2) {
      s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
      let longer = s1.length > s2.length ? s1 : s2;
      let shorter = s1.length > s2.length ? s2 : s1;
      const longerLength = longer.length;
      if (longerLength === 0) return 1.0;
      return (longerLength - editDistance(longer, shorter)) / longerLength;
    }

    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();

      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              }
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }

// ====== LISTE SPÃ‰CIALE (stockage et rendu) ======
function getSpecialKeys() {
  return JSON.parse(localStorage.getItem("specialList") || "[]"); // clÃ©s keyName
}
function setSpecialKeys(arr) {
  localStorage.setItem("specialList", JSON.stringify(arr));
}

// Ajoute le patient courant (selectedPatientIndex) Ã  la liste spÃ©ciale
function addToSpecialList() {
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[selectedPatientIndex];
  if (!p) return;
  const k = keyName(p.nom, p.prenom);
  const keys = getSpecialKeys();
  if (!keys.includes(k)) {
    keys.push(k);
    setSpecialKeys(keys);
  }
  updatePinButton();
  alert(`${p.nom} ${p.prenom} ajoutÃ© Ã  la liste spÃ©ciale.`);
  patientMenu.style.display = "none";
}

// Compte non facturÃ©es (en ignorant le futur)
function nonFactCount(p) {
  const todayStr = formatDate(new Date());
  let c = 0;
  (p.presences || []).forEach(d => {
    if (compareDates(d, todayStr) <= 0) {
      if (!p.lastFactureDate || compareDates(d, p.lastFactureDate) > 0) c++;
    }
  });
  return c;
}

// Met Ã  jour la couleur + clignotement du bouton ğŸ“Œ
function updatePinButton() {
  const btn = document.getElementById("pinButton");
  if (!btn) return;
  btn.className = "pin-btn"; // reset classes

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const keys = getSpecialKeys();

  let total = 0;
  const todayStr = formatDate(new Date());
  let anyTodayPresence = false;

  keys.forEach(k => {
    const p = patients.find(x => keyName(x.nom, x.prenom) === k);
    if (!p) return;
    total += nonFactCount(p);
    if (p.presences && p.presences.includes(todayStr)) anyTodayPresence = true;
  });

  if (total > 40)        btn.classList.add("pin-red");
  else if (total >= 30)  btn.classList.add("pin-orange");
  else if (total >= 20)  btn.classList.add("pin-yellow");
  else if (total >= 10)  btn.classList.add("pin-green");
  else                   btn.classList.add("pin-blue");

  if (!anyTodayPresence && keys.length > 0) btn.classList.add("pin-blink");
}

// Ouvre l'Ã©cran de liste spÃ©ciale
function showSpecialList() {
  hideAll();
  document.getElementById("special-screen").style.display = "block";
  renderSpecialList();
}

// Rendu de la liste spÃ©ciale (mÃªmes options/menus que la liste principale)
function renderSpecialList() {
  const listEl = document.getElementById("specialList");
  listEl.innerHTML = "";
  const keys = getSpecialKeys();
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");

  const rows = keys.map(k => {
    const i = patients.findIndex(x => keyName(x.nom, x.prenom) === k);
    return i >= 0 ? { p: patients[i], i } : null;
  }).filter(Boolean)
    .sort((a,b) => (a.p.nom + " " + a.p.prenom).localeCompare(b.p.nom + " " + b.p.prenom, 'fr', {sensitivity:'base'}));

  rows.forEach(({p, i}) => {
    const li = document.createElement("li");

    const deleteBtn = document.createElement("button");
    deleteBtn.innerHTML = "ğŸ—‘ï¸";
    deleteBtn.className = "delete-btn";
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      deletePatient(i);
      renderSpecialList();
      updatePinButton();
    };

    const nameSpan = document.createElement("span");
    nameSpan.textContent = p.nom + " " + p.prenom;

    li.appendChild(deleteBtn);
    li.appendChild(nameSpan);

    if (isPresentToday(p)) li.appendChild(makeEmoji("ğŸ™‹","PrÃ©sent aujourd'hui"));
    if (p.rejet && p.rejet.trim()) li.appendChild(makeEmoji("âš ï¸","Rejet de paiement"));
    if (p.ordNonScan) {
      li.appendChild(makeEmoji("â“", "Ordonnance non scannÃ©e", (_e,self)=>{
        const info = (p.ordDetails||"").trim();
        const txt = info ? ("ordonnance du " + info) : "Ordonnance non scannÃ©e";
        showTip(li, txt);
      }));
    }
    if (p.ordRenouv) li.appendChild(makeEmoji("ğŸ“‘","Ordonnance Ã  renouveler"));

    li.onclick = () => showPatientMenu(i);
    listEl.appendChild(li);
  });

  const total = rows.reduce((s, {p}) => s + nonFactCount(p), 0);
  const titleEl = document.getElementById("special-title");
  if (titleEl) titleEl.textContent = `Liste spÃ©ciale (${total})`;
}


// ====== RENFO DU SOIR ======
// Ajoute 2 prÃ©sences : (1) aujourd'hui, (2) jour ouvrÃ© de la semaine le moins chargÃ©.
// Si le patient est dÃ©jÃ  prÃ©sent ces jours, on choisit d'autres jours ouvrÃ©s les moins chargÃ©s.
function renfoDuSoir() {
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const p = patients[selectedPatientIndex];
  if (!p) return;

  const today = new Date();
  const todayStr = formatDate(today);

  // Lundi de la semaine courante
  const day = today.getDay(); // 0=Dim,1=Lun,...6=Sam
  const monday = new Date(today);
  const diffToMonday = (day === 0 ? -6 : 1) - day;
  monday.setDate(today.getDate() + diffToMonday);

  // 5 jours ouvrÃ©s (Lunâ†’Ven)
  const weekdays = [];
  for (let k = 0; k < 5; k++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + k);
    weekdays.push({ d, s: formatDate(d) });
  }

  // Classement par charge globale puis par date
  const ranked = weekdays
    .map(w => ({ ...w, load: countPresences(w.s) }))
    .sort((a,b) => (a.load - b.load) || (a.d - b.d));

  const toAdd = [];

  // (1) Aujourd'hui si pas dÃ©jÃ  prÃ©sent
  if (!p.presences.includes(todayStr)) toAdd.push(todayStr);

  // (2) le jour ouvrÃ© le moins chargÃ©, en Ã©vitant doublons
  for (const w of ranked) {
    if (toAdd.length >= 2) break;
    if (!p.presences.includes(w.s) && !toAdd.includes(w.s)) toAdd.push(w.s);
  }

  // Si on n'a pas 2 dates (cas limites), prendre les suivants dispo
  if (toAdd.length < 2) {
    for (const w of ranked) {
      if (toAdd.length >= 2) break;
      if (!toAdd.includes(w.s) && !p.presences.includes(w.s)) toAdd.push(w.s);
    }
  }

  toAdd.forEach(d => { if (!p.presences.includes(d)) p.presences.push(d); });

  localStorage.setItem("patients", JSON.stringify(patients));
  patientMenu.style.display = "none";

  renderPatients(document.getElementById("searchInput").value);
  updatePinButton();
}

// ====== OCR Doctolib sur l'Ã©cran Ajout patient (ajoute des fiches patients, PAS de prÃ©sences) ======
async function processAddOcrFiles() {
  const files = [
    document.getElementById("add-ocr-file-1").files[0],
    document.getElementById("add-ocr-file-2").files[0],
    document.getElementById("add-ocr-file-3").files[0],
    document.getElementById("add-ocr-file-4").files[0],
    document.getElementById("add-ocr-file-5").files[0]
  ].filter(Boolean);

  if (files.length === 0) {
    alert("SÃ©lectionne au moins une capture Doctolib.");
    return;
  }

  const zone = document.getElementById("add-ocr-results");
  const btnImport = document.getElementById("add-ocr-import-btn");
  zone.innerHTML = "ğŸ” OCR en cours...";
  btnImport.style.display = "none";

  let rawText = "";
  for (const file of files) {
    const { data: { text } } = await Tesseract.recognize(file, "fra");
    rawText += "\n" + text;
  }

  const cleaned = cleanOcrText(rawText); // -> ["NOM PrÃ©nom", ...]
  renderAddOcrResults(cleaned);
}

function renderAddOcrResults(lines) {
  const zone = document.getElementById("add-ocr-results");
  const btnImport = document.getElementById("add-ocr-import-btn");
  zone.innerHTML = "";

  if (!lines || lines.length === 0) {
    zone.innerHTML = "<p>Aucun patient dÃ©tectÃ©.</p>";
    if (btnImport) btnImport.style.display = "none";
    return;
  }

  // Patients existants â†’ pour cocher seulement les nouveaux
  const patients = JSON.parse(localStorage.getItem("patients") || "[]");
  const existingKeys = new Set(patients.map(p => keyName(p.nom, p.prenom)));

  const ul = document.createElement("ul");
  let any = false;

  // DÃ©duplication simple des lignes OCR
  Array.from(new Set(lines)).forEach(fullName => {
    const parts = String(fullName || "").trim().split(/\s+/);
    if (parts.length < 2) return;

    const surname   = (parts[0] || "").trim();
    const firstname = (parts.slice(1).join(" ") || "").trim();
    if (surname.length < 3 || firstname.length < 3) return;

    const isNew = !existingKeys.has(keyName(surname, firstname));

    const li = document.createElement("li");

    // Checkbox (avant le texte)
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = `${surname} ${firstname}`;
    cb.checked = isNew;

    // Texte nu (pas de <label>/<span>)
    li.appendChild(cb);
    li.appendChild(document.createTextNode(" " + surname + " " + firstname));

    // Optionnel : italique si le patient existe dÃ©jÃ 
    if (!isNew) li.style.fontStyle = "italic";

    // Cliquer la ligne (hors case) toggle la checkbox
    li.addEventListener("click", (e) => {
      if (e.target !== cb) cb.checked = !cb.checked;
    });

    ul.appendChild(li);
    any = true;
  });

  if (!any) {
    zone.innerHTML = "<p>Aucun patient dÃ©tectÃ©.</p>";
    if (btnImport) btnImport.style.display = "none";
    return;
  }

  zone.appendChild(ul);
  if (btnImport) btnImport.style.display = "inline-block";
}

function importAddOcrSelection() {
  const zone = document.getElementById("add-ocr-results");
  const cbs = zone.querySelectorAll("input[type=checkbox]:checked");
  const selected = Array.from(cbs).map(cb => cb.value);

  if (selected.length === 0) {
    alert("Coche au moins un patient Ã  ajouter.");
    return;
  }

  let patients = JSON.parse(localStorage.getItem("patients") || "[]");

  selected.forEach(name => {
    const parts = name.split(" ");
    const nom = (parts[0] || "").trim();
    const prenom = (parts.slice(1).join(" ") || "").trim();

    // dÃ©dup strict par clÃ© normalisÃ©e
    const k = keyName(nom, prenom);
    const exists = patients.some(p => keyName(p.nom, p.prenom) === k);
    if (!exists) {
      patients.push({ nom, prenom, phone:"", rejet:"", notes:"", presences:[], lastFactureDate:null });
    }
  });

  localStorage.setItem("patients", JSON.stringify(patients));
  // rafraÃ®chit la liste principale
  renderPatients(document.getElementById("searchInput").value);

  // feedback et reset de la zone
  alert("Ajout terminÃ©.");
  document.getElementById("add-ocr-results").innerHTML = "";
  document.getElementById("add-ocr-import-btn").style.display = "none";
}


      
          // --- TÃ©lÃ©phone & SMS ---
    function normalizePhone(num) {
      return (num || "").replace(/\s+/g, "");
    }

    function callPatient() {
      const num = document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun numÃ©ro de tÃ©lÃ©phone renseignÃ©."); return; }
      window.location.href = "tel:" + normalizePhone(num);
    }

    function smsPatient() {
      const num = document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun numÃ©ro de tÃ©lÃ©phone renseignÃ©."); return; }
      window.location.href = "sms:" + normalizePhone(num);
    }

    // --- Recherche dynamique ---
    searchInput.addEventListener("input", () => renderPatients(searchInput.value));

document.getElementById("pres-ocr-process-btn").addEventListener("click", processPresenceOcrFiles);
document.getElementById("pres-ocr-import-btn").addEventListener("click", importPresenceDatesChecked);


   // --- Init ---
showToday();
cleanupBilledToday();
showMainScreen();   // garantit un Ã©tat propre
updatePinButton();  // colore/clignote le ğŸ“Œ dÃ¨s le dÃ©part
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js", { scope: "./" })
        .then(reg => console.log("Service worker enregistrÃ©:", reg.scope))
        .catch(err => console.error("SW Ã©chec enregistrement:", err));
    });
  }
  </script>
</body>
</html>
