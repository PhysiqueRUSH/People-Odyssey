<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People Odyssey</title>
  <link rel="icon" type="image/png" href="PeopleICO.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1d3a">

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #0b1d3a;
      color: white;
    }
    header { 
      padding: 1rem; 
      text-align: center; 
      background:#112b55; 
      font-size: 1.3rem;
      font-weight: bold;
    }
    .container { padding: 1rem; }
    .today-date {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 0.3rem;
      text-align: left;
    }
    .search-bar { display: flex; margin-bottom: .5rem; }
    .search-bar input { flex: 1; padding: .6rem; border:none; border-radius:6px; }
    .actions { display:flex; justify-content:space-between; margin-bottom:1rem; }
    .actions button, .bottom-actions button { 
      background:#1f3f7a; 
      border:none; 
      padding:.5rem 1rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
    }
    .patient-list { list-style:none; padding:0; margin-bottom: 3rem; }
    .patient-list li { 
      background:#16305a; 
      margin-bottom:.5rem; 
      padding:.6rem; 
      border-radius:6px; 
      display:flex; 
      align-items:center; 
      cursor:pointer;
    }
    #add-screen, #calendar-screen, #info-screen, #presence-screen, 
    #presence-date-screen, #day-screen, #facture-screen, #ocr-import-screen { 
      display:none; padding:1rem; 
    }
    #add-screen input, #info-screen input, #info-screen textarea, 
    #presence-date-screen input, #facturation-date-screen input { 
      width:100%; 
      margin-bottom:.8rem; 
      padding:.6rem; 
      border:none; 
      border-radius:6px; 
    }
    .save-btn { background:#28a745; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; margin-right:.5rem; }
    .back-btn { background:#6c757d; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 8px;
    }
    .bottom-actions {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 1rem;
    }
    /* Menu patient */
    #patient-menu {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #patient-menu .menu-box {
      background: #112b55;
      border-radius: 8px;
      padding: 1rem;
      width: 80%;
      max-width: 400px;
    }
    #patient-menu button {
      display: block;
      width: 100%;
      margin: .4rem 0;
      background: #1f3f7a;
      border: none;
      padding: .6rem;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      text-align: left;
    }
    /* Calendrier */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      background: #16305a;
      border-radius: 4px;
      text-align: center;
      padding: .6rem;
      cursor: pointer;
      position: relative;
    }
    .calendar-day.selected { background: deepskyblue; color: white; font-weight: bold; }
    .pastille {
      width:10px;
      height:10px;
      border-radius:50%;
      position:absolute;
      bottom:4px;
      right:4px;
    }
    .phone-row {
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .phone-row input { flex: 1; }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      padding: .6rem;
      border: none;
      border-radius: 6px;
      background: #1f3f7a;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .icon-btn:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <header>People Odyssey</header>

  <!-- √âcran principal -->
  <div id="main-screen" class="container">
    <div class="today-date" id="todayDate"></div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un patient...">
    </div>

    <div class="actions">
      <button onclick="showAddScreen()">+</button>
      <button onclick="showOcrScreen()">Captures Doctolib</button>
    </div>

    <ul class="patient-list" id="patientList"></ul>

    <div class="bottom-actions">
      <button onclick="showCalendar()">Calendrier</button>
      <button onclick="showFactureScreen()">√Ä facturer</button>
    </div>
  </div>

  <!-- √âcran ajout patient -->
  <div id="add-screen" class="container">
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <button class="save-btn" onclick="savePatient()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran calendrier global -->
  <div id="calendar-screen" class="container">
    <div class="calendar-header">
      <button onclick="prevMonth()">‚óÄ</button>
      <span id="calendar-title"></span>
      <button onclick="nextMonth()">‚ñ∂</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran "√Ä facturer" -->
  <div id="facture-screen" class="container">
    <h3>Patients avec s√©ances non factur√©es</h3>
    <ul id="facture-list"></ul>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran OCR import -->
  <div id="ocr-import-screen" class="container">
    <h3>Importer depuis Doctolib</h3>
    <input type="file" id="ocr-file-1" accept="image/*"><br>
    <input type="file" id="ocr-file-2" accept="image/*"><br>
    <input type="file" id="ocr-file-3" accept="image/*"><br>
    <input type="file" id="ocr-file-4" accept="image/*"><br>
    <input type="file" id="ocr-file-5" accept="image/*"><br>
    <input type="text" id="ocr-presence-date" placeholder="jj/mm/aaaa (vide = aujourd'hui)">
    <button class="save-btn" id="ocr-process-btn">üîç Extraire</button>
    <button class="back-btn" onclick="hideOcrScreen()">‚Ü© Retour</button>
    <div id="ocr-results"></div>
    <button class="save-btn" id="ocr-import-confirm" style="display:none;">‚úÖ Importer</button>
    <button class="back-btn" onclick="hideOcrScreen()">‚úñ Annuler</button>
  </div>
    <!-- √âcran informations patient -->
  <div id="info-screen" class="container">
    <h3 id="info-title"></h3>
    <div class="phone-row">
      <input type="tel" id="info-phone" placeholder="Num√©ro de t√©l√©phone">
      <button class="icon-btn" title="Appeler" onclick="callPatient()">üìû</button>
      <button class="icon-btn" title="SMS" onclick="smsPatient()">üí¨</button>
    </div>
    <input type="text" id="info-rejet" placeholder="Rejet de paiement">
    <textarea id="info-notes" rows="4" placeholder="Autres notes..."></textarea>
    <button class="save-btn" onclick="saveInfo()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran s√©lection pr√©sences -->
  <div id="presence-screen" class="container">
    <h3>S√©lectionner les pr√©sences</h3>
    <div class="calendar-header">
      <button onclick="prevPresenceMonth()">‚óÄ</button>
      <span id="presence-title"></span>
      <button onclick="nextPresenceMonth()">‚ñ∂</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="presence-grid"></div>
    <button class="save-btn" onclick="savePresenceSelection()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran ajout pr√©sence par date -->
  <div id="presence-date-screen" class="container">
    <h3>Pr√©sent le ...</h3>
    <input type="text" id="presence-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="savePresenceByDate()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran patients d'une journ√©e -->
  <div id="day-screen" class="container">
    <h3 id="day-title"></h3>
    <ul id="day-patient-list"></ul>
    <button class="back-btn" onclick="showCalendar()">‚Ü© Retour</button>
  </div>

  <!-- √âcran date de la derni√®re facturation -->
  <div id="facturation-date-screen" class="container">
    <h3>Date de derni√®re facturation</h3>
    <input type="text" id="last-facture-date" placeholder="jj/mm/aa">
    <button class="save-btn" onclick="saveLastFactureDate()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- Menu patient -->
  <div id="patient-menu">
    <div class="menu-box">
      <button onclick="showInfoScreen()">Informations</button>
      <button onclick="addPresenceOffset(0)">Pr√©sent ce jour</button>
      <button onclick="addPresenceOffset(1)">Pr√©sent demain</button>
      <button onclick="addPresenceOffset(2)">Pr√©sent apr√®s-demain</button>
      <button onclick="showPresenceSelection()">S√©lectionner les pr√©sences</button>
      <button onclick="showPresenceByDate()">Pr√©sent le ...</button>
      <button onclick="showFactureList(true)">Liste s√©ances factur√©es</button>
      <button onclick="showFactureList(false)">Liste s√©ances non factur√©es</button>
      <button onclick="showFactureList()">Liste de toutes les s√©ances</button>
      <button onclick="showLastFactureScreen()">Date de la derni√®re facturation</button>
    </div>
  </div>
    <script>
    const patientListEl = document.getElementById("patientList");
    const searchInput = document.getElementById("searchInput");
    const patientMenu = document.getElementById("patient-menu");
    const todayDateEl = document.getElementById("todayDate");
    const dayPatientList = document.getElementById("day-patient-list");

    let currentYear, currentMonth;
    let presenceYear, presenceMonth;
    let selectedPatientIndex = null;
    let presenceSelection = new Set();
    let currentDayView = null;

    // --- Utilitaires dates ---
    function formatDate(date) {
      return date.toLocaleDateString("fr-FR");
    }

    // Normaliser une date entr√©e par l'utilisateur (jj/mm/aa ‚Üí jj/mm/aaaa)
    function normalizeDate(input) {
      const parts = input.split("/");
      if (parts.length === 3) {
        let [jj, mm, aa] = parts;
        if (aa.length === 2) aa = "20" + aa;
        return `${jj.padStart(2,"0")}/${mm.padStart(2,"0")}/${aa}`;
      }
      return input;
    }

    // Afficher la date du jour
    function showToday() {
      const today = new Date();
      const options = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
      todayDateEl.textContent = today.toLocaleDateString("fr-FR", options);
    }

    // Compter les pr√©sences pour une date
    function countPresences(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let count = 0;
      patients.forEach(p => {
        if (p.presences && p.presences.includes(dateStr)) count++;
      });
      return count;
    }
          // --- Gestion Patients ---
    function renderPatients(filter = "") {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patientListEl.innerHTML = "";

      patients
        .filter(p => (p.nom + " " + p.prenom).toLowerCase().includes(filter.toLowerCase()))
        .forEach((p, index) => {
          const li = document.createElement("li");

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "üóëÔ∏è";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePatient(index);
          };

          const span = document.createElement("span");
          span.textContent = p.nom + " " + p.prenom;
          if (p.rejet && p.rejet.trim() !== "") span.textContent += " ‚ö†Ô∏è";

          li.appendChild(deleteBtn);
          li.appendChild(span);
          li.onclick = () => showPatientMenu(index);

          patientListEl.appendChild(li);
        });
    }

    function savePatient() {
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      if (!nom || !prenom) {
        alert("Veuillez remplir Nom et Pr√©nom");
        return;
      }
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.push({ nom, prenom, phone:"", rejet:"", notes:"", presences:[], lastFactureDate:null });
      localStorage.setItem("patients", JSON.stringify(patients));
      document.getElementById("nom").value = "";
      document.getElementById("prenom").value = "";
      showMainScreen();
      renderPatients(searchInput.value);
    }

    function deletePatient(index) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.splice(index, 1);
      localStorage.setItem("patients", JSON.stringify(patients));
      renderPatients(searchInput.value);
    }

    // --- Navigation ---
    function showAddScreen() {
      hideAll();
      document.getElementById("add-screen").style.display = "block";
    }
    function showMainScreen() {
      hideAll();
      document.getElementById("main-screen").style.display = "block";
      renderPatients(searchInput.value);
    }
    function showCalendar() {
      hideAll();
      document.getElementById("calendar-screen").style.display = "block";
      renderCalendar();
    }
    function showInfoScreen() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("info-screen").style.display = "block";

      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      document.getElementById("info-title").textContent = p.nom + " " + p.prenom;
      document.getElementById("info-phone").value = p.phone || "";
      document.getElementById("info-rejet").value = p.rejet || "";
      document.getElementById("info-notes").value = p.notes || "";
    }
    function showPresenceSelection() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("presence-screen").style.display = "block";

      const today = new Date();
      presenceYear = today.getFullYear();
      presenceMonth = today.getMonth();
      presenceSelection = new Set(
        (JSON.parse(localStorage.getItem("patients"))[selectedPatientIndex].presences || [])
      );
      renderPresenceCalendar();
    }
    function showPresenceByDate() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("presence-date-screen").style.display = "block";
    }
    function showDayScreen(dateStr) {
      hideAll();
      document.getElementById("day-screen").style.display = "block";
      updateDayTitle(dateStr);
      currentDayView = dateStr;
      renderDayPatients(dateStr);
    }
    function showLastFactureScreen() {
      patientMenu.style.display = "none";
      hideAll();
      document.getElementById("facturation-date-screen").style.display = "block";
    }
    function showFactureScreen() {
      hideAll();
      document.getElementById("facture-screen").style.display = "block";
      renderFactureList();
    }
    function showOcrScreen() {
      hideAll();
      document.getElementById("ocr-import-screen").style.display = "block";
    }
    function hideOcrScreen() {
      hideAll();
      document.getElementById("main-screen").style.display = "block";
    }

    function hideAll() {
      ["main-screen","add-screen","calendar-screen","info-screen",
       "presence-screen","presence-date-screen","day-screen",
       "facturation-date-screen","facture-screen","ocr-import-screen"]
       .forEach(id => { document.getElementById(id).style.display="none"; });
    }
          // --- Menu patient ---
    function showPatientMenu(index) {
      selectedPatientIndex = index;
      patientMenu.style.display = "flex";
    }
    patientMenu.addEventListener("click", (e) => {
      if (e.target === patientMenu) {
        patientMenu.style.display = "none";
      }
    });

    // --- Sauvegarde infos ---
    function saveInfo() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      if (selectedPatientIndex === null) return;
      patients[selectedPatientIndex].phone = document.getElementById("info-phone").value.trim();
      patients[selectedPatientIndex].rejet = document.getElementById("info-rejet").value.trim();
      patients[selectedPatientIndex].notes = document.getElementById("info-notes").value.trim();
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    // --- Ajout pr√©sence rapide ---
    function addPresenceOffset(offset) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      const d = new Date();
      d.setDate(d.getDate() + offset);
      const dateStr = formatDate(d);
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      patientMenu.style.display = "none";
    }

    // --- Ajout pr√©sence par date ---
    function savePresenceByDate() {
      let dateStr = document.getElementById("presence-date").value.trim();
      if (!dateStr) return;
      dateStr = normalizeDate(dateStr);
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      if (!p.presences.includes(dateStr)) p.presences.push(dateStr);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }
          // --- Calendrier global ---
    function renderCalendar() {
      const titleEl = document.getElementById("calendar-title");
      const gridEl = document.getElementById("calendar-grid");

      const today = new Date();
      if (currentYear === undefined) {
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
      }

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const monthName = firstDay.toLocaleString("fr-FR", { month: "long" });

      titleEl.textContent = monthName + " " + currentYear;
      gridEl.innerHTML = "";

      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for (let i = 0; i < startDay; i++) {
        gridEl.appendChild(document.createElement("div"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(currentYear, currentMonth, d);
        const dateStr = formatDate(date);
        const count = countPresences(dateStr);

        const dayEl = document.createElement("div");
        dayEl.className = "calendar-day";
        dayEl.textContent = d;

        if (count > 40) dayEl.classList.add("red");
        else if (count >= 35) dayEl.classList.add("orange");
        else if (count >= 5) dayEl.classList.add("green");
        else if (count >= 1) dayEl.classList.add("blue");

        // Pastille facturation
        const pct = facturePercentage(dateStr);
        if (pct !== null) {
          const pastille = document.createElement("div");
          pastille.className = "pastille";
          if (pct === 0) pastille.style.background = "darkgreen";
          else if (pct > 50) pastille.style.background = "red";
          else if (pct > 0) pastille.style.background = "orange";
          dayEl.appendChild(pastille);
        }

        dayEl.onclick = () => showDayScreen(dateStr);
        gridEl.appendChild(dayEl);
      }
    }
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    // --- Calendrier pr√©sences (multi s√©lection) ---
    function renderPresenceCalendar() {
      const titleEl = document.getElementById("presence-title");
      const gridEl = document.getElementById("presence-grid");

      const firstDay = new Date(presenceYear, presenceMonth, 1);
      const lastDay = new Date(presenceYear, presenceMonth + 1, 0);
      const monthName = firstDay.toLocaleString("fr-FR", { month: "long" });

      titleEl.textContent = monthName + " " + presenceYear;
      gridEl.innerHTML = "";

      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for (let i = 0; i < startDay; i++) {
        gridEl.appendChild(document.createElement("div"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(presenceYear, presenceMonth, d);
        const dateStr = formatDate(date);
        const dayEl = document.createElement("div");
        dayEl.className = "calendar-day";
        dayEl.textContent = d;

        if (presenceSelection.has(dateStr)) {
          dayEl.classList.add("selected");
        }

        dayEl.onclick = () => {
          if (presenceSelection.has(dateStr)) {
            presenceSelection.delete(dateStr);
            dayEl.classList.remove("selected");
          } else {
            presenceSelection.add(dateStr);
            dayEl.classList.add("selected");
          }
        };

        gridEl.appendChild(dayEl);
      }
    }
    function prevPresenceMonth(){
      presenceMonth--;
      if (presenceMonth < 0) { presenceMonth = 11; presenceYear--; }
      renderPresenceCalendar();
    }
    function nextPresenceMonth(){
      presenceMonth++;
      if (presenceMonth > 11) { presenceMonth = 0; presenceYear++; }
      renderPresenceCalendar();
    }
    function savePresenceSelection() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].presences = Array.from(presenceSelection);
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }
          // --- Liste des patients d'une journ√©e ---
    function updateDayTitle(dateStr) {
      const total = countPresences(dateStr);
      document.getElementById("day-title").textContent =
        "Pr√©sents le " + dateStr + " ‚Äî " + total + " patient(s)";
    }

    function renderDayPatients(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      dayPatientList.innerHTML = "";
      patients.forEach((p, idx) => {
        if (p.presences && p.presences.includes(dateStr)) {
          const li = document.createElement("li");
          const delBtn = document.createElement("button");
          delBtn.textContent = "üóëÔ∏è";
          delBtn.className = "delete-btn";
          delBtn.onclick = () => {
            p.presences = p.presences.filter(d => d !== dateStr);
            patients[idx] = p;
            localStorage.setItem("patients", JSON.stringify(patients));
            renderDayPatients(dateStr);
            updateDayTitle(dateStr);
          };
          li.appendChild(delBtn);
          const span = document.createElement("span");
          span.textContent = p.nom + " " + p.prenom;
          li.appendChild(span);
          dayPatientList.appendChild(li);
        }
      });
    }

    // --- Facturation ---
    function saveLastFactureDate() {
      const dateStr = normalizeDate(document.getElementById("last-facture-date").value.trim());
      if (!dateStr) return;
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients[selectedPatientIndex].lastFactureDate = dateStr;
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    // Retourne % de s√©ances non factur√©es pour une date
    function facturePercentage(dateStr) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      let total = 0, nonFact = 0;
      patients.forEach(p => {
        if (p.presences && p.presences.includes(dateStr)) {
          total++;
          if (!p.lastFactureDate || compareDates(dateStr, p.lastFactureDate) > 0) {
            nonFact++;
          }
        }
      });
      if (total === 0) return null;
      return (nonFact / total) * 100;
    }

    function compareDates(d1, d2) {
      const [j1,m1,a1] = d1.split("/").map(Number);
      const [j2,m2,a2] = d2.split("/").map(Number);
      const date1 = new Date(a1,m1-1,j1);
      const date2 = new Date(a2,m2-1,j2);
      if (date1 > date2) return 1;
      if (date1 < date2) return -1;
      return 0;
    }

    // Liste patients "√Ä facturer"
    function renderFactureList() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const ul = document.getElementById("facture-list");
      ul.innerHTML = "";

      const today = new Date();
      const all = patients.map(p => {
        let nonFact = 0;
        (p.presences || []).forEach(dateStr => {
          if (!p.lastFactureDate || compareDates(dateStr, p.lastFactureDate) > 0) {
            nonFact++;
          }
        });
        return { ...p, nonFact };
      }).filter(p => p.nonFact > 0);

      all.sort((a,b) => {
        if (b.nonFact !== a.nonFact) return b.nonFact - a.nonFact;
        return (a.nom + " " + a.prenom).localeCompare(b.nom + " " + b.prenom);
      });

      all.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.nom + " " + p.prenom + " (" + p.nonFact + ")";
        if (p.nonFact > 20) li.style.color = "red";
        else if (p.nonFact >= 10) li.style.color = "orange";
        else if (p.nonFact >= 5) li.style.color = "yellow";
        else if (p.nonFact >= 2) li.style.color = "green";
        else li.style.color = "skyblue";
        ul.appendChild(li);
      });
    }
    // --- OCR Doctolib ---
    async function processOcrFiles() {
      const files = [
        document.getElementById("ocr-file-1").files[0],
        document.getElementById("ocr-file-2").files[0],
        document.getElementById("ocr-file-3").files[0],
        document.getElementById("ocr-file-4").files[0],
        document.getElementById("ocr-file-5").files[0]
      ].filter(f => f);

      if (files.length === 0) {
        alert("Veuillez s√©lectionner au moins une capture.");
        return;
      }

      document.getElementById("ocr-results").innerHTML = "üîç OCR en cours...";
      let rawText = "";

      for (const file of files) {
        const { data: { text } } = await Tesseract.recognize(file, "fra");
        rawText += "\n" + text;
      }

      const cleaned = cleanOcrText(rawText);
      showOcrResults(cleaned);
    }

    // Nettoyage du texte OCR 
    function cleanOcrText(text) {
  // 1) Nettoyage large des lignes
  const lines = text.split("\n")
    .map(l => l.replace(/\d{1,2}[:h]\d{2}/g,""))             // heures
    .map(l => l.replace(/\d{1,2}\/\d{1,2}\/\d{2,4}/g,""))     // dates
    .map(l => l.replace(/[|@+]/g," "))                        // symboles parasites
    .map(l => l.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø \-']/g, " "))      // garde lettres/accents/espaces/tirets/'
    .map(l => l.replace(/\s+/g," ").trim())
    .filter(l => l.length > 2);

  const results = new Set();

  for (const raw of lines) {
    const normalized = normalizeOcrName(raw);
    if (normalized) results.add(normalized);
  }
  return Array.from(results);
}

// Extrait strictement "NOM Pr√©nom" √† partir d'une ligne
function normalizeOcrName(line) {
  if (!line) return null;

  // Tokenise en conservant accents et tirets
  const tokens = line.split(/\s+/).filter(Boolean);

  // S√©pare les tokens UPPERCASE (NOM) des tokens Pr√©nom (Capitalis√©s)
  const up = [];
  const first = [];

  for (const t of tokens) {
    const hasLetter = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(t);
    if (!hasLetter) continue;

    const isUpper = t === t.toUpperCase() && t.length >= 2;
    const isCap   = /^[A-Z√Ä-√ñ√ò-√û][a-z√†-√∂√∏-√ø'‚Äô-]+$/.test(t); // Pr√©nom capitalis√©, accents ok

    if (isUpper) up.push(t);
    else if (isCap) first.push(t);
  }

  if (up.length === 0 || first.length === 0) return null;

  // Cas "NOM NOM Pr√©nom" ‚Üí si doublon initial exact, on compacte
  // ex: DUPONT DUPONT Pierre ‚Üí DUPONT Pierre
  let surname = up[0];
  if (up.length >= 2 && up[0].replace(/[-‚Äô']/g,"") === up[1].replace(/[-‚Äô']/g,"")) {
    surname = up[0]; // garde un seul
  }

  // Si plusieurs NOM diff√©rents d√©tect√©s (ligne bavarde), on prend le premier bloc UPPER plausible
  // et on ignore le reste pour rester strict.
  const firstname = first.join(" ");

  // Filtre final : NOM = 2+ lettres, Pr√©nom = 2+ lettres
  if (surname.length < 2 || firstname.length < 2) return null;

  return `${surname} ${firstname}`;
}


    function showOcrResults(lines) {
      const div = document.getElementById("ocr-results");
      div.innerHTML = "";
      if (lines.length === 0) {
        div.innerHTML = "<p>Aucun patient d√©tect√©.</p>";
        return;
      }

      const ul = document.createElement("ul");
      lines.forEach(l => {
        const li = document.createElement("li");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.value = l;
        li.appendChild(cb);
        li.appendChild(document.createTextNode(" " + l));
        ul.appendChild(li);
      });
      div.appendChild(ul);
      document.getElementById("ocr-import-confirm").style.display = "inline-block";
    }

    document.getElementById("ocr-process-btn").addEventListener("click", processOcrFiles);

   document.getElementById("ocr-import-confirm").addEventListener("click", () => {
  const div = document.getElementById("ocr-results");
  const cbs = div.querySelectorAll("input[type=checkbox]:checked");
  const selectedNames = Array.from(cbs).map(cb => cb.value);

  // Date de pr√©sence (aujourd'hui par d√©faut)
  let dateStr = document.getElementById("ocr-presence-date").value.trim();
  if (!dateStr) dateStr = formatDate(new Date());
  else dateStr = normalizeDate(dateStr);

  const patients = JSON.parse(localStorage.getItem("patients") || "[]");

  // Set de cl√©s normalis√©es existantes (utile si tu veux l‚Äôutiliser ailleurs)
  const existingKeys = new Set(patients.map(p => keyName(p.nom, p.prenom)));

  selectedNames.forEach(name => {
    // cleanOcrText() renvoie d√©j√† "NOM Pr√©nom" strict ‚Üí split simple
    const parts = name.split(" ");
    const nom = parts[0] || "";
    const prenom = parts.slice(1).join(" ") || "";

    const k = keyName(nom, prenom);

    // 1) Match EXACT par cl√© normalis√©e
    let match = patients.find(p => keyName(p.nom, p.prenom) === k);

    // 2) Sinon, fallback flou (plus strict que ton 0.7 ‚Üí 0.85)
    if (!match) {
      match = patients.find(p => similarity(p.nom + " " + p.prenom, name) > 0.85);
    }

    if (!match) {
      // Cr√©e le patient et ajoute la pr√©sence du jour choisi
      patients.push({
        nom,
        prenom,
        phone: "",
        rejet: "",
        notes: "",
        presences: [dateStr],
        lastFactureDate: null
      });
    } else {
      // Ajoute la pr√©sence si elle n‚Äôexiste pas
      if (!match.presences.includes(dateStr)) match.presences.push(dateStr);
    }
  });

  localStorage.setItem("patients", JSON.stringify(patients));
  hideOcrScreen();
  showMainScreen();
});


function keyName(nom, prenom) {
  return (nom + "|" + prenom).toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // retire accents
    .replace(/[^a-z\-| ]/g,"")                        // garde lettres, espaces, tirets, |
    .replace(/\s+/g," ").trim();
}

      
    // Fonction de similarit√© floue (Levenshtein)
    function similarity(s1, s2) {
      s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
      let longer = s1.length > s2.length ? s1 : s2;
      let shorter = s1.length > s2.length ? s2 : s1;
      const longerLength = longer.length;
      if (longerLength === 0) return 1.0;
      return (longerLength - editDistance(longer, shorter)) / longerLength;
    }

    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();

      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else {
            if (j > 0) {
              let newValue = costs[j - 1];
              if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
              }
              costs[j - 1] = lastValue;
              lastValue = newValue;
            }
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }
      
          // --- T√©l√©phone & SMS ---
    function normalizePhone(num) {
      return (num || "").replace(/\s+/g, "");
    }

    function callPatient() {
      const num = document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun num√©ro de t√©l√©phone renseign√©."); return; }
      window.location.href = "tel:" + normalizePhone(num);
    }

    function smsPatient() {
      const num = document.getElementById("info-phone").value.trim();
      if (!num) { alert("Aucun num√©ro de t√©l√©phone renseign√©."); return; }
      window.location.href = "sms:" + normalizePhone(num);
    }

    // --- Recherche dynamique ---
    searchInput.addEventListener("input", () => renderPatients(searchInput.value));

    // --- Init ---
    showToday();
    renderPatients();
  </script>
</body>
</html>
