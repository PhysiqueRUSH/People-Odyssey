<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People Odyssey</title>
  <link rel="icon" type="image/png" href="PeopleICO.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1d3a">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #0b1d3a;
      color: white;
    }
    header { 
      padding: 1rem; 
      text-align: center; 
      background:#112b55; 
      font-size: 1.3rem;
      font-weight: bold;
    }
    .container { padding: 1rem; }
    .today-date {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 0.3rem;
      text-align: left;
    }
    .search-bar { display: flex; margin-bottom: .5rem; }
    .search-bar input { flex: 1; padding: .6rem; border:none; border-radius:6px; }
    .actions { display:flex; justify-content:space-between; margin-bottom:1rem; }
    .actions button, .bottom-actions button { 
      background:#1f3f7a; 
      border:none; 
      padding:.5rem 1rem; 
      border-radius:6px; 
      color:white; 
      cursor:pointer; 
    }
    .patient-list { list-style:none; padding:0; margin-bottom: 3rem; }
    .patient-list li { 
      background:#16305a; 
      margin-bottom:.5rem; 
      padding:.6rem; 
      border-radius:6px; 
      display:flex; 
      align-items:center; 
      cursor:pointer;
    }
    #add-screen, #calendar-screen, #info-screen { display:none; padding:1rem; }
    #add-screen input, #info-screen input, #info-screen textarea { 
      width:100%; 
      margin-bottom:.8rem; 
      padding:.6rem; 
      border:none; 
      border-radius:6px; 
    }
    .save-btn { background:#28a745; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; margin-right:.5rem; }
    .back-btn { background:#6c757d; border:none; padding:.6rem 1.2rem; border-radius:6px; color:white; cursor:pointer; }
    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 8px;
    }
    .bottom-actions {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 1rem;
    }
    /* Menu patient */
    #patient-menu {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #patient-menu .menu-box {
      background: #112b55;
      border-radius: 8px;
      padding: 1rem;
      width: 80%;
      max-width: 400px;
    }
    #patient-menu button {
      display: block;
      width: 100%;
      margin: .4rem 0;
      background: #1f3f7a;
      border: none;
      padding: .6rem;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      text-align: left;
    }
    /* Calendrier */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #ccc;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      background: #16305a;
      border-radius: 4px;
      text-align: center;
      padding: .6rem;
      cursor: pointer;
    }
    /* √âcran infos */
    .info-actions {
      display: flex;
      align-items: center;
      margin-bottom: .8rem;
    }
    .info-actions input {
      flex: 1;
      margin-right: .5rem;
    }
    .icon-btn {
      background: #1f3f7a;
      border: none;
      border-radius: 6px;
      color: white;
      padding: .5rem;
      margin-left: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>People Odyssey</header>

  <!-- √âcran principal -->
  <div id="main-screen" class="container">
    <div class="today-date" id="todayDate"></div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un patient...">
    </div>

    <div class="actions">
      <button onclick="showAddScreen()">+</button>
      <button>Liste sp√©ciale</button>
    </div>

    <ul class="patient-list" id="patientList"></ul>

    <div class="bottom-actions">
      <button onclick="showCalendar()">Calendrier</button>
      <button>√Ä facturer</button>
    </div>
  </div>

  <!-- √âcran ajout patient -->
  <div id="add-screen" class="container">
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <button class="save-btn" onclick="savePatient()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran calendrier -->
  <div id="calendar-screen" class="container">
    <div class="calendar-header">
      <button onclick="prevMonth()">‚óÄ</button>
      <span id="calendar-title"></span>
      <button onclick="nextMonth()">‚ñ∂</button>
    </div>
    <div class="calendar-weekdays">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- √âcran informations patient -->
  <div id="info-screen" class="container">
    <h3 id="info-title"></h3>
    <div class="info-actions">
      <input type="tel" id="info-phone" placeholder="Num√©ro de t√©l√©phone">
      <button class="icon-btn" id="callBtn">üìû</button>
      <button class="icon-btn" id="smsBtn">üí¨</button>
    </div>
    <input type="text" id="info-rejet" placeholder="Rejet de paiement">
    <textarea id="info-notes" rows="4" placeholder="Autres notes..."></textarea>
    <button class="save-btn" onclick="saveInfo()">üíæ Enregistrer</button>
    <button class="back-btn" onclick="showMainScreen()">‚Ü© Retour</button>
  </div>

  <!-- Menu patient -->
  <div id="patient-menu">
    <div class="menu-box">
      <button onclick="showInfoScreen()">Informations</button>
      <button>Pr√©sent ce jour</button>
      <button>Pr√©sent demain</button>
      <button>Pr√©sent apr√®s-demain</button>
      <button>Pr√©sent le ...</button>
      <button>Liste s√©ances factur√©es</button>
      <button>Liste s√©ances non factur√©es</button>
      <button>Liste de toutes les s√©ances</button>
      <button>Date de la derni√®re facturation</button>
    </div>
  </div>

  <script>
    const patientListEl = document.getElementById("patientList");
    const searchInput = document.getElementById("searchInput");
    const patientMenu = document.getElementById("patient-menu");
    const todayDateEl = document.getElementById("todayDate");

    let currentYear, currentMonth;
    let selectedPatientIndex = null;

    // Afficher date du jour
    function showToday() {
      const today = new Date();
      const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
      todayDateEl.textContent = today.toLocaleDateString("fr-FR", options);
    }

    function renderPatients(filter = "") {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patientListEl.innerHTML = "";

      patients
        .filter(p => (p.nom + " " + p.prenom).toLowerCase().includes(filter.toLowerCase()))
        .forEach((p, index) => {
          const li = document.createElement("li");

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "üóëÔ∏è";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePatient(index);
          };

          const span = document.createElement("span");
          span.textContent = p.nom + " " + p.prenom;
          if (p.rejet && p.rejet.trim() !== "") {
            span.textContent += " ‚ö†Ô∏è";
          }

          li.appendChild(deleteBtn);
          li.appendChild(span);
          li.onclick = () => showPatientMenu(index);

          patientListEl.appendChild(li);
        });
    }

    function savePatient() {
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      if (!nom || !prenom) { 
        alert("Veuillez remplir Nom et Pr√©nom"); 
        return; 
      }
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.push({nom, prenom, phone:"", rejet:"", notes:""});
      localStorage.setItem("patients", JSON.stringify(patients));
      document.getElementById("nom").value = "";
      document.getElementById("prenom").value = "";
      showMainScreen();
      renderPatients(searchInput.value);
    }

    function deletePatient(index) {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      patients.splice(index, 1);
      localStorage.setItem("patients", JSON.stringify(patients));
      renderPatients(searchInput.value);
    }

    function showAddScreen() {
      document.getElementById("main-screen").style.display = "none";
      document.getElementById("add-screen").style.display = "block";
    }
    function showMainScreen() {
      document.getElementById("main-screen").style.display = "block";
      document.getElementById("add-screen").style.display = "none";
      document.getElementById("calendar-screen").style.display = "none";
      document.getElementById("info-screen").style.display = "none";
      patientMenu.style.display = "none";
      renderPatients(searchInput.value);
    }
    function showCalendar() {
      document.getElementById("main-screen").style.display = "none";
      document.getElementById("calendar-screen").style.display = "block";
      renderCalendar();
    }

    // üî• Recherche dynamique
    searchInput.addEventListener("input", () => {
      renderPatients(searchInput.value);
    });

    // Menu patient
    function showPatientMenu(index) {
      selectedPatientIndex = index;
      patientMenu.style.display = "flex";
    }
    patientMenu.addEventListener("click", (e) => {
      if (e.target === patientMenu) {
        patientMenu.style.display = "none";
      }
    });

    // √âcran infos patient
    function showInfoScreen() {
      patientMenu.style.display = "none";
      document.getElementById("main-screen").style.display = "none";
      document.getElementById("info-screen").style.display = "block";

      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      const p = patients[selectedPatientIndex];
      document.getElementById("info-title").textContent = p.nom + " " + p.prenom;
      document.getElementById("info-phone").value = p.phone || "";
      document.getElementById("info-rejet").value = p.rejet || "";
      document.getElementById("info-notes").value = p.notes || "";

      document.getElementById("callBtn").onclick = () => {
        if (p.phone) window.location.href = "tel:" + p.phone;
      };
      document.getElementById("smsBtn").onclick = () => {
        if (p.phone) window.location.href = "sms:" + p.phone;
      };
    }

    function saveInfo() {
      const patients = JSON.parse(localStorage.getItem("patients") || "[]");
      if (selectedPatientIndex === null) return;
      patients[selectedPatientIndex].phone = document.getElementById("info-phone").value.trim();
      patients[selectedPatientIndex].rejet = document.getElementById("info-rejet").value.trim();
      patients[selectedPatientIndex].notes = document.getElementById("info-notes").value.trim();
      localStorage.setItem("patients", JSON.stringify(patients));
      showMainScreen();
    }

    // Calendrier
    function renderCalendar() {
      const titleEl = document.getElementById("calendar-title");
      const gridEl = document.getElementById("calendar-grid");

      const today = new Date();
      if (currentYear === undefined) {
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
      }

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const monthName = firstDay.toLocaleString("fr-FR", { month: "long" });

      titleEl.textContent = monthName + " " + currentYear;
      gridEl.innerHTML = "";

      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Lundi=0
      for (let i = 0; i < startDay; i++) {
        gridEl.appendChild(document.createElement("div"));
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dayEl = document.createElement("div");
        dayEl.className = "calendar-day";
        dayEl.textContent = d;
        dayEl.onclick = () => alert("Jour s√©lectionn√© : " + d + "/" + (currentMonth+1) + "/" + currentYear);
        gridEl.appendChild(dayEl);
      }
    }
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    // Initialisation
    showToday();
    renderPatients();
  </script>

  <!-- Enregistrement Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
          .then(reg => console.log("‚úÖ Service Worker enregistr√© :", reg.scope))
          .catch(err => console.error("‚ùå Erreur Service Worker :", err));
      });
    }
  </script>
</body>
</html>
